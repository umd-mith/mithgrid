/*
 * mithgrid JavaScript Library v0.0.1
 *
 * Date: Fri Sep 30 06:11:02 2011 -0700
 *
 * (c) Copyright University of Maryland 2011.  All rights reserved.
 *
 * (c) Copyright Texas A&M University 2010.  All rights reserved.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    documentation and/or other materials provided with the distribution.
 *
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
(function(){var a,b,c,d,e,f,g=Array.prototype.slice,h=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};a=(d=this.MITHGrid)!=null?d:this.MITHGrid={},b=(e=this.fluid)!=null?e:this.fluid={},c=(f=this.jQuery)!=null?f:this.jQuery={},function(a,c){var d,e,f,i,j,k,l,m,n;(typeof window!="undefined"&&window!==null?(n=window.console)!=null?n.log:void 0:void 0)!=null?c.debug=window.console.log:c.debug=function(){},c.error=function(){c.debug.call({},arguments);return{arguments:arguments}},k=function(a,b){var d;a[b]==null&&(d={namespace:function(a){return k(d,a)},debug:c.debug});return a[b]=d},c.namespace=function(a){return k(c,a)},j={},c.defaults=function(b,c){j[b]||(j[b]={});return j[b]=a.extend(!0,j[b],c)},c.initEventFirer=function(a,b){var c,d;d={},d.isPreventable=a,d.isUnicast=b,c=[],d.addListener=function(a,b){return c.push([a,b])},d.removeListener=function(a){var a;return typeof a=="string"?c=function(){var b,d,e;e=[];for(b=0,d=c.length;b<d;b++)a=c[b],a[1]!==a&&e.push(a);return e}():c=function(){var b,d,e;e=[];for(b=0,d=c.length;b<d;b++)a=c[b],a[0]!==a&&e.push(a);return e}()},b?d.fire=function(){var a,b;a=1<=arguments.length?g.call(arguments,0):[];if(c.length<=0)return!0;try{return(b=c[0])[0].apply(b,a)}catch(d){return console.log(d)}}:a?d.fire=function(){var a,b,d,e,f,h;a=1<=arguments.length?g.call(arguments,0):[],e=!0;for(f=0,h=c.length;f<h;f++){d=c[f],b=d[0];try{e=b.apply(null,a)}catch(i){console.log(i)}if(e===!1)return!1}return!0}:d.fire=function(){var a,b,d,e;a=1<=arguments.length?g.call(arguments,0):[];for(d=0,e=c.length;d<e;d++){b=c[d];try{b[0].apply(b,a)}catch(f){console.log(f)}}return!0};return d},l=0,c.initView=function(b,d,e){var f,g,i,k,m,n,o;e==null&&(e=d,d=void 0),n={},m={},f=b.split("."),k=f.shift(),m=a.extend(!0,{},j[k]||{});while(f.length>0)k=k+"."+f.shift(),m=a.extend(!0,m,j[k]||{});m=a.extend(!0,m,e||{}),l+=1,n.id=l,n.options=m,n.container=d,n.events={};if(n.options.events!=null){o=n.options.events;for(i in o)g=o[i],g!=null?typeof g=="string"&&(g=[g]):g=[],n.events[i]=c.initEventFirer(h.call(g,"preventable")>=0,h.call(g,"unicast")>=0)}return n},e=c.namespace("Data"),e.initSet=function(a){var b,c,d,e,f,g,h,i;g={},d={},b=0,f=!0,e=[],g.isSet=!0,g.items=function(){var a;if(f){e=[];for(a in d)typeof a=="string"&&d[a]===!0&&e.push(a)}return e},g.add=function(a){if(d[a]==null){d[a]=!0,f=!0;return b+=1}},g.remove=function(a){if(d[a]!=null){delete d[a],f=!0;return b-=1}},g.visit=function(a){var b,c;c=[];for(b in d)if(a(b)===!0)break;return c},g.contains=function(a){return d[a]!=null},g.size=function(){return f?g.items().length:e.length};if(a instanceof Array)for(h=0,i=a.length;h<i;h++)c=a[h],g.add(c);return g},e.initType=function(a){var b;return b={name:a,custom:{}}},e.initProperty=function(a){var b;return b={name:a,getValueType:function(){var a;return(a=b.valueType)!=null?a:"text"}}},e.initStore=function(b){var d,f,g,i,j,k,l,m,n,o;k=!1,l=e.initSet(),o={},j={},m={},i={},g=function(a,b,c,d){var e,f,g;g=a[b],g==null&&(g={values:{},counts:{}},a[b]=g),e=g.values[c],f=g.counts[c],e==null&&(e=[],g.values[c]=e);if(f==null)f={},g.counts[c]=f;else if(h.call(e,d)>=0){f[d]+=1;return}e.push(d);return f[d]=1},f=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;g=a[b];if(g!=null){f=g.values[c];if(f!=null){if(e!=null){m=[];for(i=0,k=f.length;i<k;i++)h=f[i],m.push(e.contains(h)?d.add(h):void 0);return m}n=[];for(j=0,l=f.length;j<l;j++)h=f[j],n.push(d.add(h));return n}}},d=function(a,b,c,d,g){d==null&&(d=e.initSet()),b.visit(function(b){return f(a,b,c,d,g)});return d},b!=null?b:b={},n=c.initView("MITHGrid.Data.initStore",b),n.items=l.items,n.contains=l.contains,n.addProperty=function(a,b){var c;c=e.initProperty(a),(b!=null?b.valueType:void 0)!=null&&(c.valueType=b.valueType,j[a]=c);return c},n.getProperty=function(a){var b;return(b=j[a])!=null?b:e.initProperty(a)},n.addType=function(a,b){var c;c=e.initType(a),o[a]=c;return c},n.getType=function(a){var b;return(b=o[a])!=null?b:e.initType(a)},n.getItem=function(a){var b,c;return(b=(c=m[a])!=null?c.values:void 0)!=null?b:{}},n.getItems=function(b){if(!a.isArray(b))return[n.getItem(b)];return a.map(b,function(a,b){return n.getItem(a)})},n.fetchData=function(b){return a.ajax({url:b,dataType:"json",success:function(a,b){return n.loadData(a)}})},n.removeItems=function(b){var c,d,e,f,g,h,j,k;d=[],e=function(b,c,d,e){var f,g,h,i,j,k,l;h=b[c];if(h!=null){f=h.values[d],g=h.counts[d];if(f==null||g==null)return;g[e]-=1;if(g[e]<1){i=a.inArray(e,f),i===0?f=f.slice(1,f.length):i===f.length-1?f=f.slice(0,i):i>0&&(f=f.slice(0,i).concat(f.slice(i+1,f.length))),f.length>0?h.values[d]=f:delete h.values[d],delete g[e],k=0;for(j in g)l=g[j],k+=l;if(k===0)return delete b[c]}}},f=function(a,b,c){e(m,a,b,c);return e(i,c,b,a)},h=function(a,b,c){var d,e,g,h;h=[];for(e=0,g=c.length;e<g;e++)d=c[e],h.push(f(a,b,d));return h},g=function(b,c){var d,e,f,g;d=n.getItem(b),g=d.type,a.isArray(g)&&(g=g[0]);for(f in d){e=d[f];if(typeof f!="string"||f==="id"||f==="type")continue;h(b,f,e)}return h(b,"type",[g])};for(j=0,k=b.length;j<k;j++)c=b[j],g(c,f),d.push(c),l.remove(c);return n.events.onModelChange.fire(n,d)},n.updateItems=function(b){var c,d,e,f,h,j,k,l;e=[],h=function(b,c,d,e){var f,g,h,i;h=b[c];if(h!=null){f=h.values[d],g=h.counts[d];if(f==null||g==null)return;g[e]-=1;if(g[e]<1){i=a.inArray(e,f),i===0?f=f.slice(1,f.length):i===f.length-1?f=f.slice(0,i):i>0&&(f=f.slice(0,i).concat(f.slice(i+1,f.length))),f.length>0?h.values[d]=f:delete h.values[d];return delete g[e]}}},f=function(a,b,c){g(m,a,b,c);return g(i,c,b,a)},j=function(a,b,c){h(m,a,b,c);return h(i,c,b,a)},l=function(b,c,d){var e,f,g,h,i,j,k,l,m,o;f=b.id,o=b.type,e=!1,g=function(a,b){var c,d,e;d=!0;if(a.length!==b.length)return!1;for(c=0,e=a.length;0<=e?c<e:c>e;0<=e?c++:c--)a[c]!==b[c]&&(d=!1);return d},l=function(a,b,c){var e,f,g,h;h=[];for(f=0,g=c.length;f<g;f++)e=c[f],h.push(d(a,b,e));return h},k=function(a,b,d){var e,f,g,h;h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(c(a,b,e));return h},a.isArray(f)&&(f=f[0]),a.isArray(o)&&(o=o[0]),i=n.getItem(f);for(j in b){h=b[j];if(typeof j!="string"||j==="id"||j==="type")continue;a.isArray(h)||(h=[h]),m=h.length,i[j]==null?(k(f,j,h),e=!0):g(h,i[j])||(e=!0,l(f,j,i[j]),k(f,j,h))}return e},n.events.onBeforeUpdating.fire(n),k=b.length,c=parseInt(k/100,10),c>200&&(c=200),c<1&&(c=1),d=function(a){var g,h,i;g=a+c,g>k&&(g=k);for(i=a;a<=g?i<g:i>g;a<=g?i++:i--)h=b[i],typeof h=="object"&&l(h,f,j)&&e.push(h.id);if(g<k)return setTimeout(function(){return d(g)},0);n.events.onAfterUpdating.fire(n);return n.events.onModelChange.fire(n,e)};return d(0)},n.loadItems=function(b,d){var e,f,h,j,k,o;h=[],j=function(a,b,c){g(m,a,b,c);return g(i,c,b,a)},k=function(b,d){var e,f,g,i,k,m;if(b.id==null)throw c.error("Item entry has no id: ",b);if(b.type==null)throw c.error("Item entry has no type: ",b);e=b.id,g=b.type,a.isArray(e)&&(e=e[0]),a.isArray(g)&&(g=g[0]),l.add(e),h.push(e),j(e,"type",g),j(e,"id",e),m=[];for(f in b){i=b[f];if(typeof f!="string")continue;m.push(function(){var b,c,d;if(f!=="id"&&f!=="type"){if(a.isArray(i)){d=[];for(b=0,c=i.length;b<c;b++)k=i[b],d.push(j(e,f,k));return d}if(i!=null)return j(e,f,i)}}())}return m},n.events.onBeforeLoading.fire(n),o=b.length,d!=null?(e=parseInt(o/100,10),e>200&&(e=200),e<1&&(e=1)):e=o,f=function(a){var c,g,i;c=a+e,c>o&&(c=o);for(i=a;a<=c?i<c:i>c;a<=c?i++:i--)g=b[i],typeof g=="object"&&k(g);return c<o?setTimeout(function(){return f(c)},0):setTimeout(function(){n.events.onAfterLoading.fire(n);return setTimeout(function(){n.events.onModelChange.fire(n,h);if(d!=null)return setTimeout(d,0)},0)},0)};return f(0)},n.prepare=function(a){var b,d;d=function(){var d,e,f;f=[];for(d=0,e=a.length;d<e;d++)b=a[d],f.push(c.Expression.initParser().parse(b));return f}();return{evaluate:function(a){var b,c,e,f,g;c=[],e=function(b){var d;d=b.evaluateOnItem(a,n);return c=c.concat(d.values.items())};for(f=0,g=d.length;f<g;f++)b=d[f],e(b);return c}}},n.getObjectsUnion=function(a,b,c,e){return d(m,a,b,c,e)},n.getSubjectsUnion=function(a,b,c,e){return d(i,a,b,c,e)};return n},e.initView=function(a){var b,d,f,g,i;f=c.initView("MITHGrid.Data.initView",a),d=e.initSet(),b=function(a){var b,c,g,h;d=e.initSet(),g=f.dataStore.items(),h=g.length;if(h===0)a();else{h>200?(b=parseInt(h/100,10),b>200&&(b=200)):b=h,b<1&&(b=1),c=function(e){var i,j,k,l;i=e+b,i>h&&(i=h);for(k=e;e<=i?k<i:k>i;e<=i?k++:k--)l=g[k],j=f.events.onFilterItem.fire(f.dataStore,l),j!==!1&&d.add(l);if(i<h)return setTimeout(function(){return c(i)},0);f.items=d.items,f.size=d.size,f.contains=d.contains;if(a!=null)return setTimeout(a,0)};return c(0)}},f.registerFilter=function(a){f.events.onFilterItem.addListener(function(b,c){return a.eventFilterItem(b,c)}),f.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return a.events.onFilterChange.addListener(f.eventFilterChange)},f.registerPresentation=function(a){f.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return b(function(){return a.eventModelChange(f,f.items())})},f.items=d.items,f.size=d.size,f.contains=d.contains,(a!=null?(g=a.types)!=null?g.length:void 0:void 0)>0&&function(a){return f.registerFilter({eventFilterItem:function(b,c){var d,e,f,g;d=b.getItem(c);if(d.type==null)return!1;for(f=0,g=a.length;f<g;f++){e=a[f];if(h.call(d.type,e)>=0)return}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(a.types),(a!=null?(i=a.filters)!=null?i.length:void 0:void 0)>0&&function(a){var b,d,e;e=c.Expression.initParser(),d=function(){var c,d,f;f=[];for(c=0,d=a.length;c<d;c++)b=a[c],f.push(e.parse(b));return f}();return f.registerFilter({eventFilterItem:function(a,b){var c,e,f,g,h,i,j;for(g=0,i=d.length;g<i;g++){c=d[g],f=c.evaluateOnItem(b,a),f=f.values.items();for(h=0,j=f.length;h<j;h++){e=f[h];if(e!=="false")return}}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(a.filters),(a!=null?a.collection:void 0)!=null&&f.registerFilter({eventFilterItem:a.collection,eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}}),f.eventModelChange=function(a,c){var d;d=e.initSet(f.items());return b(function(){var a,b,g,h,i,j,k;a=e.initSet(),k=f.items();for(g=0,i=k.length;g<i;g++)b=k[g],d.add(b);for(h=0,j=c.length;h<j;h++)b=c[h],d.contains(b)&&a.add(b);if(a.size()>0)return f.events.onModelChange.fire(f,a.items())})},f.eventFilterChange=f.eventModelChange,f.dataStore=a.dataStore,f.getItems=f.dataStore.getItems,f.getItem=f.dataStore.getItem,f.removeItems=f.dataStore.removeItems,f.fetchData=f.dataStore.fetchData,f.updateItems=f.dataStore.updateItems,f.loadItems=f.dataStore.loadItems,f.prepare=f.dataStore.prepare,f.addType=f.dataStore.addType,f.getType=f.dataStore.getType,f.addProperty=f.dataStore.addProperty,f.getProperty=f.dataStore.getProperty,f.getObjectsUnion=f.dataStore.getObjectsUnion,f.getSubjectsUnion=f.dataStore.getSubjectsUnion,f.dataStore.events.onModelChange.addListener(f.eventModelChange);return f},f=c.namespace("Expression"),m={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b}},"=":{valueType:"boolean",f:function(a,b){return a===b}},"<>":{valueType:"boolean",f:function(a,b){return a!==b}},"><":{valueType:"boolean",f:function(a,b){return a!==b}},"<":{valueType:"boolean",f:function(a,b){return a<b}},">":{valueType:"boolean",f:function(a,b){return a>b}},"<=":{valueType:"boolean",f:function(a,b){return a<=b}},">=":{valueType:"boolean",f:function(a,b){return a>=b}}},f.controls={"if":{f:function(a,b,c,d,e){var f,g;g=a[0].evaluate(b,c,d,e),f=!1,g.forEachValue(function(a){if(a){f=!0;return!0}});return f?a[1].evaluate(b,c,d,e):a[2].evaluate(b,c,d)}},foreach:{f:function(a,b,c,d,e){var g,h,i,j,k;g=a[0].evaluate(b,c,d,e),h=b.value,i=c.value,j=[],k="text",c.value=g.valueType,g.forEachValue(function(f){var g;b.value=f,g=a[1].evaluate(b,c,d,e),k=g.valueType;return g.forEachValue(function(a){return j.push(a)})}),b.value=h,c.value=i;return f.initCollection(j,k)}},"default":{f:function(a,b,c,d,e){var g,h,i,j;for(i=0,j=a.length;i<j;i++){g=a[i],h=g.evaluate(b,c,d,e);if(h.size()>0)return h}return f.initCollection([],"text")}}},f.initExpression=function(a){var b;b={},b.evaluate=function(b,c,d,e){var f;f=a.evaluate(b,c,d,e);return{values:f.getSet(),valueType:f.valueType,size:f.size}},b.evaluateOnItem=function(a,b){return this.evaluate({value:a},{value:"item"},"value",b)},b.evaluateSingle=function(b,c,d,e){var f,g;f=a.evaluate(b,c,d,e),g={value:null,valueType:f.valueType},f.forEachValue(function(a){g.value=a;return!0});return g},b.isPath=a.isPath,b.isPath?(b.getPath=function(){return a},b.testExists=function(b,c,d,e){return a.testExists(b,c,d,e)}):(b.getPath=function(){return null},b.testExists=function(a,c,d,e){return b.evaluate(a,c,d,e).values.size()>0}),b.evaluateBackward=function(b,c,d,e){return a.walkBackward([b],c,d,e)},b.walkForward=function(b,c,d){return a.walkForward(b,c,d)},b.walkBackward=function(b,c,d,e){return a.walkBackward(b,c,d,e)};return b},f.initCollection=function(a,b){var d;d={valueType:b},a instanceof Array?(d.forEachValue=function(b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++){c=a[d];if(b(c)===!0)break}return f},d.getSet=function(){return c.Data.initSet(a)},d.contains=function(b){return h.call(a,b)>=0},d.size=function(){return a.length}):(d.forEachValue=a.visit,d.size=a.size,d.getSet=function(){return a},d.contains=a.contains),d.isPath=!1;return d},f.initConstant=function(a,b){var c;c={},c.evaluate=function(c,d,e,g){return f.initCollection([a],b)},c.isPath=!1;return c},f.initOperator=function(a,b){var c,d,e;c={},e=a,d=b,c.evaluate=function(c,g,h,i){var j,k,l,n,o;l=[],b=[];for(n=0,o=d.length;n<o;n++)j=d[n],b.push(j.evaluate(c,g,h,i));a=m[e],k=a.f,a.argumentType==="number"?b[0].forEachValue(function(a){typeof a!="number"&&(a=parseFloat(a));return b[1].forEachValue(function(b){typeof b!="number"&&(b=parseFloat(b));return l.push(k(a,b))})}):b[0].forEachValue(function(a){return b[1].forEachValue(function(b){return l.push(k(a,b))})});return f.initCollection(l,a.valueType)},c.isPath=!1;return c},f.initFunctionCall=function(a,b){var c,d;c={},d=b,c.evaluate=function(c,e,g,h){var i,j,k,l;b=[];for(j=0,k=d.length;j<k;j++)i=d[j],b.push(i.evaluate(c,e,g,h));if(((l=f.functions[a])!=null?l.f:void 0)!=null)return f.functions[a].f(b);throw new Error("No such function named "+_name)},c.isPath=!1;return c},f.initControlCall=function(a,b){var c;c={},c.evaluate=function(c,d,e,g){return f.controls[a].f(b,c,d,e,g)},c.isPath=!1;return c},f.initPath=function(a,b){var d,e,g,h,i;d={},h=null,i=[],g=function(b,c){var d,e,g,h,j,k,l,m;g=function(a){var d;d=[],b.forEachValue(function(b){return c.getObjects(b,a.property).visit(function(a){return d.push(a)})});return d},e=function(a){var d;d=[],b.forEachValue(function(b){return c.getSubjects(b,a.property).visit(function(a){return d.push(a)})});return d};for(h=0,m=i.length;0<=m?h<m:h>m;0<=m?h++:h--)j=i[h],j.isMultiple?(d=[],j.forward?(d=g(j),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text"):(d=e(j),k="item"),b=f.initCollection(d,k)):j.forward?(l=c.getObjectsUnion(b.getSet(),j.property),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text",b=f.initCollection(l,k)):(l=c.getSubjectsUnion(b.getSet(),j.property),b=f.initCollection(l,"item"));return b},e=function(b,d,e){var g,h,j,k,l,m,n,o;j=function(a){var c;c=[],b.forEachValue(function(b){return e.getSubjects(b,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return c.push(a)})});return c},h=function(a){var c;c=[],b.forEachValue(function(b){return e.getObjects(b,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return c.push(a)})});return c},d instanceof Array&&(d=c.Data.initSet(d));for(k=o=i.length-1;o<=0?k<=0:k>=0;o<=0?k++:k--)l=i[k],l.isMultiple?(g=[],l.forward?(g=j(l),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text"):(g=h(l),m="item"),b=f.initCollection(g,m)):l.forward?(n=e.getSubjectsUnion(b.getSet(),l.property,null,k===0?d:null),b=f.initCollection(n,"item")):(n=e.getObjectsUnion(b.getSet(),l.property,null,k===0?d:null),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text",b=f.initCollection(n,m));return b},a!=null&&i.push({property:a,forward:b,isMultiple:!1}),d.isPath=!0,d.setRootName=function(a){return h=a},d.appendSegment=function(a,b){return i.push({property:a,forward:b[0]===".",isMultiple:b.length>1})},d.getSegment=function(a){var b;if(a<i.length){b=i[a];return{property:b.property,forward:b.forward,isMultiple:b.isMultiple}}return null},d.getLastSegment=function(){return d.getSegment(i.length-1)},d.getSegmentCount=function(){return i.length},d.rangeBackward=function(b,d,e,f){var g,h,j,k,l;j=c.Data.initSet(),k="item";if(i.length>0){h=i[i.length-1];if(h.forward)f.getSubjectsInRange(h.property,b,d,!1,j,i.length===1?e:null);else throw new Error("Last path of segment must be forward");for(g=l=i.length-2;l<=0?g<=0:g>=0;l<=0?g++:g--)h=i[g],h.forward?(j=f.getSubjectsUnion(j,h.property,null,g===0?e:null),k="item"):(j=f.getObjectsUnion(j,h.property,null,g===0?e:null),a=f.getPropertysegment.property,k=a!=null?a.getValueType():"text")}return{valueType:k,values:j,count:j.size()}},d.evaluate=function(a,b,c,d){var e,i,j,k;j=h!=null?h:c,k=b[j]!=null?b[j]:"text",e=null;if(a[j]!=null){i=a[j],i.isSet||i instanceof Array?e=f.initCollection(i,k):e=f.initCollection([i],k);return g(e,d)}throw new Error("No such variable called "+j)},d.testExists=function(a,b,c,e){return d.evaluate(a,b,c,e).size()>0},d.evaluateBackward=function(a,b,c,d){var g;g=f.initCollection([a],b);return e(g,c,d)},d.walkForward=function(a,b,c){return g(f.initCollection(a,b),c)},d.walkBackward=function(a,b,c,d){return e(f.initCollection(a,b),c,d)};return d},f.initParser=function(){var a,b;b={},a=function(a,b){var c,d,e,g,h,i,j,k,l,m,n,o,p,q,r;p=a.token(),c=f.initScanner,g=function(){a.next();return p=a.token()},j=function(){},m=function(){var a,b,d;b=j();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="*"||d==="/"))a=p.value,g(),b=f.initOperator(a,[b,j()]);return b},l=function(){var a,b,d;b=m();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="+"||d==="-"))a=p.value,g(),b=f.initOperator(a,[b,m()]);return b},h=function(){var a,b,d;a=l();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="="||d==="<>"||d==="<"||d===">"||d==="<="||d===">="))b=p.value,g(),a=f.initOperator(b,[a,l()]);return a},i=function(){var a;a=[h()];while(p!=null&&p.type===c.DELIMITER&&p.value===",")g(),a.push(h());return a},e=function(){return p!=null?p.start:a.index()},k=function(){var a,b;b=f.initPath();while(p!=null&&p.type===c.PATH_OPERATOR){a=p.value,g();if(p!=null&&p.type===c.IDENTIFIER)b.appendSegment(p.value,a),g();else throw new Error("Missing property ID at position "+e())}return b},j=function(){var a,b,d;d=null,a=[];if(p==null)throw new Error("Missing factor at end of expression");switch(p.type){case c.NUMBER:d=f.initConstant(p.value,"number"),g();break;case c.STRING:d=f.initConstant(p.value,"text"),g();break;case c.PATH_OPERATOR:d=k();break;case c.IDENTIFIER:b=p.value,g();if(f.controls[b]!=null){if(p==null||p.type!==c.DELIMITER||p.value!=="(")throw new Error("Missing ( to start "+b+" at position "+e());g(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=f.initControlCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) to end "+b+" at position "+e())}else if(p!=null&&p.type===c.DELIMITER&&p.value==="("){g(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=f.initFunctionCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) after function call "+b+" at position "+e())}else d=k(),d.setRootName(b);break;case c.DELIMITER:if(p.value!=="(")throw new Error("Unexpected text "+p.value+" at position "+e());g(),d=h();if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) at position "+e());break;default:throw new Error("Unexpected text "+p.value+" at position "+e())}return d};if(b){o=i(),d=[];for(q=0,r=o.length;q<r;q++)n=o[q],d.push(f.initExpression(n));return d}return[f.initExpression(h())]},b.parse=function(b,c,d){var e;c!=null?c:c=0,d!=null?d:d={},e=f.initScanner(b,c);try{return a(e,!1)[0]}finally{d.index=e.token()!=null?e.token().start:e.index()}};return b},f.initScanner=function(a,b){var c,d,e,g,h,i;d={},h=a+" ",g=a.length,e=b,i=null,c=function(a){return"0123456789".indexOf(a)>=0},d.token=function(){return i},d.index=function(){return e},d.next=function(){var a,b,d,j;i=null;while(e<g&&" \t\r\n".indexOf(h.charAt(e))>=0)e+=1;if(e<g){b=h.charAt(e),d=h.charAt(e+1);if(".!".indexOf(b)<0){if("<>".indexOf(b)<0){if("+-*/=".indexOf(b)<0){if("()".indexOf(b)<0){if("\"'".indexOf(b)<0){if(c(b)){j=e;while(j<g&&c(h.charAt(j)))j+=1;if(j<g&&h.charAt(j)==="."){j+=1;while(j<g&&c(h.charAt(j)))j+=1}i={type:f.initScanner.NUMBER,value:parseFloat(h.substring(e,j)),start:e,end:j};return e=j}j=e;while(j<g){a=h.charAt(j);if("(),.!@ \t".indexOf(a)>=0)break;j+=1}i={type:f.initScanner.IDENTIFIER,value:h.substring(e,j),start:e,end:j};return e=j}j=e+1;while(j<g){if(h.charAt(j)===b&&h.charAt(j-1)!=="\\")break;j+=1}if(j<g){i={type:f.initScanner.STRING,value:h.substring(e+1,j).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:e,end:j+1};return e=j+1}throw new Error("Unterminated string starting at "+String(e))}i={type:f.initScanner.DELIMITER,value:b,start:e,end:e+1};return e+=1}i={type:f.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="="||"<>".indexOf(d)>=0&&b!==d){i={type:f.initScanner.OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:f.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="@"){i={type:f.initScanner.PATH_OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:f.initScanner.PATH_OPERATOR,value:b,start:e,end:e+1};return e+=1}},d.next();return d},f.initScanner.DELIMITER=0,f.initScanner.NUMBER=1,f.initScanner.STRING=2,f.initScanner.IDENTIFIER=3,f.initScanner.OPERATOR=4,f.initScanner.PATH_OPERATOR=5,f.functions={},f.FunctionUtilities={},f.FunctionUtilities.registerSimpleMappingFunction=function(a,b,d){return f.functions[a]={f:function(a){var e,g,h,i,j;h=c.Data.initSet(),g=function(a){return a.forEachValue(function(a){var c;c=b(a);if(c!=null)return h.add(c)})};for(i=0,j=a.length;i<j;i++)e=a[i],g(e);return f.initCollection(h,d)}}},c.namespace("Presentation"),c.Presentation.initPresentation=function(b,d,e){var f,g,h;h={},h=c.initView("MITHGrid.Presentation."+b,d,e),g={},f=h.options.lenses,e=h.options,a(d).empty(),h.getLens=function(a){if(a.type!=null&&a.type[0]!=null&&f[a.type[0]]!=null)return{render:f[a.type[0]]}},h.renderingFor=function(a){return g[a]},h.renderItems=function(a,b){var c,e;e=b.length,c=function(f){var i,j,k,l,m,n;if(f<e){i=e,e>200&&(i=f+parseInt(Math.sqrt(e),10)+1,i>e&&(i=e));for(k=f;f<=i?k<i:k>i;f<=i?k++:k--)l=b[k],j=a.contains(l),j?g[l]!=null?g[l].update(a.getItem(l)):(m=h.getLens(a.getItem(l)),m!=null&&(g[l]=m.render(d,h,a,l))):g[l]!=null&&(typeof (n=g[l]).remove=="function"&&n.remove(),delete g[l]);return setTimeout(function(){return c(i)},0)}return h.finishDisplayUpdate()},h.startDisplayUpdate();return c(0)},h.eventModelChange=h.renderItems,h.startDisplayUpdate=function(){},h.finishDisplayUpdate=function(){},h.selfRender=function(){return h.renderItems(h.dataView,h.dataView.items())},h.dataView=h.options.dataView,h.dataView.registerPresentation(h);return h},i=c.namespace("Facet"),i.initFacet=function(d,e,f){var g;g=c.initView(d,e,f),f=g.options,g.selfRender=function(){},g.eventFilterItem=function(a,b){return!1},g.eventModelChange=function(a,b){},g.constructFacetFrame=function(b,c){var d;d={},a(b).addClass("mithgrid-facet"),d.header=a("<div class='header' />"),c.onClearAllSelections!=null&&(d.controls=a("<div class='control' title='Clear Selection'>"),d.counter=a("<span class='counter'></span>"),d.controls.append(d.counter),d.header.append(d.controls)),d.title=a("<span class='title'></span>"),d.title.text(c.facetLabel||""),d.header.append(d.title),d.bodyFrame=a("<div class='body-frame'></div>"),d.body=a("<div class='body'></div>"),d.bodyFrame.append(d.body),a(b).append(d.header),a(b).append(d.bodyFrame),c.onClearAllSelections!=null&&d.controls.bind("click",c.onClearAllSelections),d.setSelectionCount=function(a){d.counter.innerHTML=a;return a>0?d.counter.show():d.counter.hide()};return d},g.events||(g.events={}),g.events.onFilterChange=b.event.getEventFirer(),f.dataView.registerFilter(g);return g},i.namespace("TextSearch"),i.TextSearch.initFacet=function(b,d){var e,f,g;g=i.initFacet("MITHGrid.Facet.TextSearch",b,d),d=g.options,d.expressions!=null&&(a.isArray(d.expressions)||(d.expressions=[d.expressions],f=function(){var a,b,f,g;f=d.expressions,g=[];for(a=0,b=f.length;a<b;a++)e=f[a],g.push(c.Expression.initParser().parse(e));return g}())),g.eventFilterItem=function(a,b){var c,e,h,i,j,k,l,m;if(g.text!=null&&d.expressions!=null)for(i=0,k=f.length;i<k;i++){c=f[i],e=c.evaluateOnItem(b,a),m=e.values.items();for(j=0,l=m.length;j<l;j++){h=m[j];if(h.toLowerCase().indexOf(g.text)>=0)return}}return!1},g.eventModelChange=function(a,b){},g.selfRender=function(){var c,e;c=g.constructFacetFrame(b,null,{facetLabel:d.facetLabel}),a(b).addClass("mithgrid-facet-textsearch"),e=a("<input type='text'>"),c.body.append(e);return e.keyup(function(){g.text=a.trim(e.val().toLowerCase());return g.events.onFilterChange.fire()})};return g},i.namespace("List"),i.List.initFacet=function(b,d){var e,f,g;g=i.initFacet("MITHGrid.Facet.List",b,d),d=g.options,g.selections=[],d.expressions!=null&&(a.isArray(d.expressions)||(d.expressions=[d.expressions],f=function(){var a,b,f,g;f=d.expressions,g=[];for(a=0,b=f.length;a<b;a++)e=f[a],g.push(c.Expression.initParser().parse(e));return g}())),g.eventFilterItem=function(a,b){var c,e,i,j,k,l,m,n,o;if(g.text!=null&&d.expressions!=null){o=[];for(j=0,l=f.length;j<l;j++){c=f[j],e=c.evaluateOnItem(b,a),n=e.values.items();for(k=0,m=n.length;k<m;k++){i=n[k];if(h.call(g.selections,i)>=0)return}}return o}},g.selfRender=function(){var a;return a=g.constructFacetFrame(b,null,{facetLabel:d.facetLabel,resizable:!0})};return g},d=c.namespace("Application"),d.initApp=function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;l=c.initView(b,d,e),g=[],l.presentation={},l.facet={},l.dataStore={},l.dataView={},e=l.options,l.ready=function(a){return g.push(a)};if((e!=null?e.dataStores:void 0)!=null){s=e.dataStores;for(k in s){f=s[k],l.dataStore[k]==null?(j=c.Data.initStore(),l.dataStore[k]=j,j.addType("Item"),j.addProperty("label",{valueType:"text"}),j.addProperty("type",{valueType:"text"}),j.addProperty("id",{valueType:"text"})):j=l.dataStore[k];if((f!=null?f.types:void 0)!=null){t=f.types;for(m in t)n=t[m],j.addType(m)}if((f!=null?f.properties:void 0)!=null){u=f.properties;for(h in u)i=u[h],j.addProperty(h,i)}}}if((e!=null?e.dataViews:void 0)!=null){v=e.dataViews;for(q in v)p=v[q],r={dataStore:l.dataStore[p.dataStore],label:q},l.dataView[q]==null&&(p.collection!=null&&(r.collection=p.collection),p.types!=null&&(r.types=p.types),p.filters!=null&&(r.filters=p.filters),o=c.Data.initView(r),l.dataView[q]=o)}(e!=null?e.viewSetup:void 0)!=null&&(a.isFunction(e.viewSetup)?l.ready(function(){return e.viewSetup(a(d))}):l.ready(function(){return a(d).append(e.viewSetup)})),(e!=null?e.facets:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j;i=e.facets,j=[];for(b in i)f=i[b],h=a.extend(!0,{},f),g=a(d).find(f.container),a.isArray(g)&&(g=g[0]),h.dataView=l.dataView[f.dataView],h.application=l,c=f.type.initFacet(g,h),l.facet[b]=c,j.push(c.selfRender());return j}),(e!=null?e.presentations:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j;i=e.presentations,j=[];for(b in i)c=i[b],g=a.extend(!0,{},c),f=a(d).find(g.container),a.isArray(f)&&(f=f[0]),g.dataView=l.dataView[c.dataView],g.application=l,h=c.type.initPresentation(f,g),l.presentation[b]=h,j.push(h.selfRender());return j}),(e!=null?e.plugins:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j,k,m,n,o,p,q,r,s;r=e.plugins,s=[];for(p=0,q=r.length;p<q;p++)b=r[p],f=b.type.initPlugin(b),s.push(function(){var e,p,q,r;if(f!=null){if((b!=null?b.dataView:void 0)!=null){f.dataView=l.dataView[b.dataView],e=f.getTypes();for(n in e)o=e[n],f.dataView.addType(n);p=f.getProperties();for(j in p)k=p[j],f.dataView.addProperty(j,k)}q=f.getPresentations(),r=[];for(g in q)h=q[g],m=a.extend(!0,{},h.options),c=a(d).find(h.container),a.isArray(c)&&(c=c[0]),(h!=null?h.lenses:void 0)!=null&&(m.lenses=h.lenses),h.dataView!=null?m.dataView=l.dataView[h.dataView]:b.dataView!=null&&(m.dataView=l.dataView[b.dataView]),m.application=l,i=h.type.initPresentation(c,m),f.presentation[g]=i,r.push(i.selfRender());return r}}());return s}),l.run=function(){return a(document).ready(function(){var a,b,c;for(b=0,c=g.length;b<c;b++)a=g[b],a();g=[];return l.ready=function(a){return setTimeout(a,0)}})};return l},c.namespace("Plugin");return c.Plugin.initPlugin=function(a,b){var c,d;d={options:b,presentation:{}},c=[],d.getTypes=function(){return(b!=null?b.types:void 0)!=null?b.types:[]},d.getProperties=function(){return(b!=null?b.properties:void 0)!=null?b.properties:[]},d.getPresentations=function(){return(b!=null?b.presentations:void 0)!=null?b.presentations:[]},d.ready=c.push,d.eventReady=function(a){var b,e,f;for(e=0,f=c.length;e<f;e++)b=c[e],b(a);c=[];return d.ready=function(b){return b(a)}};return d}}(c,a),a.defaults("MITHGrid.Data.initStore",{events:{onModelChange:null,onBeforeLoading:null,onAfterLoading:null,onBeforeUpdating:null,onAfterUpdating:null}}),a.defaults("MITHGrid.Data.initView",{events:{onModelChange:null,onFilterItem:"preventable"}}),a.defaults("MITHGrid.Facet",{}),a.defaults("MITHGrid.Facet.TextSearch",{facetLabel:"Search",expressions:[".label"]})}).call(this);