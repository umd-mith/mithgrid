/*
 * mithgrid JavaScript Library v0.0.1
 *
 * Date: Mon Oct 10 15:13:06 2011 -0400
 *
 * (c) Copyright University of Maryland 2011.  All rights reserved.
 *
 * (c) Copyright Texas A&M University 2010.  All rights reserved.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    documentation and/or other materials provided with the distribution.
 *
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
(function(){var a,b,c,d,e=Array.prototype.slice,f=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};a=(c=this.MITHGrid)!=null?c:this.MITHGrid={},b=(d=this.jQuery)!=null?d:this.jQuery={},function(a,b){var c,d,g,h,i,j,k,l,m;(typeof window!="undefined"&&window!==null?(m=window.console)!=null?m.log:void 0:void 0)!=null?b.debug=window.console.log:b.debug=function(){},b.error=function(){b.debug.call({},arguments);return{arguments:arguments}},j=function(a,c){var d;a[c]==null&&(d={namespace:function(a){return j(d,a)},debug:b.debug});return a[c]=d},b.namespace=function(a){return j(b,a)},i={},b.defaults=function(b,c){i[b]||(i[b]={});return i[b]=a.extend(!0,i[b],c)},b.initEventFirer=function(a,b){var c,d;d={},d.isPreventable=a,d.isUnicast=b,c=[],d.addListener=function(a,b){return c.push([a,b])},d.removeListener=function(a){var a;return typeof a=="string"?c=function(){var b,d,e;e=[];for(b=0,d=c.length;b<d;b++)a=c[b],a[1]!==a&&e.push(a);return e}():c=function(){var b,d,e;e=[];for(b=0,d=c.length;b<d;b++)a=c[b],a[0]!==a&&e.push(a);return e}()},b?d.fire=function(){var a,b;a=1<=arguments.length?e.call(arguments,0):[];if(c.length<=0)return!0;try{return(b=c[0])[0].apply(b,a)}catch(d){return console.log(d)}}:a?d.fire=function(){var a,b,d,f,g,h;a=1<=arguments.length?e.call(arguments,0):[],f=!0;for(g=0,h=c.length;g<h;g++){d=c[g],b=d[0];try{f=b.apply(null,a)}catch(i){console.log(i)}if(f===!1)return!1}return!0}:d.fire=function(){var a,b,d,f;a=1<=arguments.length?e.call(arguments,0):[];for(d=0,f=c.length;d<f;d++){b=c[d];try{b[0].apply(b,a)}catch(g){console.log(b[0],a,g)}}return!0};return d},k=0,b.initView=function(c,d,e){var g,h,j,l,m,n,o;e==null&&(e=d,d=void 0),n={},m={},g=c.split("."),l=g.shift(),m=a.extend(!0,{},i[l]||{});while(g.length>0)l=l+"."+g.shift(),m=a.extend(!0,m,i[l]||{});m=a.extend(!0,m,e||{}),k+=1,n.id=k,n.options=m,n.container=d,n.events={};if(n.options.events!=null){o=n.options.events;for(j in o)h=o[j],h!=null?typeof h=="string"&&(h=[h]):h=[],n.events[j]=b.initEventFirer(f.call(h,"preventable")>=0,f.call(h,"unicast")>=0)}return n},d=b.namespace("Data"),d.initSet=function(a){var b,c,d,e,f,g,h,i;g={},d={},b=0,f=!0,e=[],g.isSet=!0,g.items=function(){var a;if(f){e=[];for(a in d)typeof a=="string"&&d[a]===!0&&e.push(a)}return e},g.add=function(a){if(d[a]==null){d[a]=!0,f=!0;return b+=1}},g.remove=function(a){if(d[a]!=null){delete d[a],f=!0;return b-=1}},g.visit=function(a){var b,c;c=[];for(b in d)if(a(b)===!0)break;return c},g.contains=function(a){return d[a]!=null},g.size=function(){return f?g.items().length:e.length};if(a instanceof Array)for(h=0,i=a.length;h<i;h++)c=a[h],g.add(c);return g},d.initType=function(a){var b;return b={name:a,custom:{}}},d.initProperty=function(a){var b;return b={name:a,getValueType:function(){var a;return(a=b.valueType)!=null?a:"text"}}},d.initStore=function(c){var e,g,h,i,j,k,l,m,n,o;k=!1,l=d.initSet(),o={},j={},m={},i={},h=function(a,b,c,d){var e,g,h;h=a[b],h==null&&(h={values:{},counts:{}},a[b]=h),e=h.values[c],g=h.counts[c],e==null&&(e=[],h.values[c]=e);if(g==null)g={},h.counts[c]=g;else if(f.call(e,d)>=0){g[d]+=1;return}e.push(d);return g[d]=1},g=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;g=a[b];if(g!=null){f=g.values[c];if(f!=null){if(e!=null){m=[];for(i=0,k=f.length;i<k;i++)h=f[i],m.push(e.contains(h)?d.add(h):void 0);return m}n=[];for(j=0,l=f.length;j<l;j++)h=f[j],n.push(d.add(h));return n}}},e=function(a,b,c,e,f){e==null&&(e=d.initSet()),b.visit(function(b){return g(a,b,c,e,f)});return e},c!=null?c:c={},n=b.initView("MITHGrid.Data.initStore",c),n.items=l.items,n.contains=l.contains,n.addProperty=function(a,b){var c;c=d.initProperty(a),(b!=null?b.valueType:void 0)!=null&&(c.valueType=b.valueType,j[a]=c);return c},n.getProperty=function(a){var b;return(b=j[a])!=null?b:d.initProperty(a)},n.addType=function(a,b){var c;c=d.initType(a),o[a]=c;return c},n.getType=function(a){var b;return(b=o[a])!=null?b:d.initType(a)},n.getItem=function(a){var b,c;return(b=(c=m[a])!=null?c.values:void 0)!=null?b:{}},n.getItems=function(b){if(!a.isArray(b))return[n.getItem(b)];return a.map(b,function(a,b){return n.getItem(a)})},n.fetchData=function(b){return a.ajax({url:b,dataType:"json",success:function(a,b){return n.loadData(a)}})},n.removeItems=function(b){var c,d,e,f,g,h,j,k;d=[],e=function(b,c,d,e){var f,g,h,i,j,k,l;h=b[c];if(h!=null){f=h.values[d],g=h.counts[d];if(f==null||g==null)return;g[e]-=1;if(g[e]<1){i=a.inArray(e,f),i===0?f=f.slice(1,f.length):i===f.length-1?f=f.slice(0,i):i>0&&(f=f.slice(0,i).concat(f.slice(i+1,f.length))),f.length>0?h.values[d]=f:delete h.values[d],delete g[e],k=0;for(j in g)l=g[j],k+=l;if(k===0)return delete b[c]}}},f=function(a,b,c){e(m,a,b,c);return e(i,c,b,a)},h=function(a,b,c){var d,e,g,h;h=[];for(e=0,g=c.length;e<g;e++)d=c[e],h.push(f(a,b,d));return h},g=function(b,c){var d,e,f,g;d=n.getItem(b),g=d.type,a.isArray(g)&&(g=g[0]);for(f in d){e=d[f];if(typeof f!="string"||f==="id"||f==="type")continue;h(b,f,e)}return h(b,"type",[g])};for(j=0,k=b.length;j<k;j++)c=b[j],g(c,f),d.push(c),l.remove(c);return n.events.onModelChange.fire(n,d)},n.updateItems=function(b){var c,d,e,f,g,j,k,l;e=[],g=function(b,c,d,e){var f,g,h,i;h=b[c];if(h!=null){f=h.values[d],g=h.counts[d];if(f==null||g==null)return;g[e]-=1;if(g[e]<1){i=a.inArray(e,f),i===0?f=f.slice(1,f.length):i===f.length-1?f=f.slice(0,i):i>0&&(f=f.slice(0,i).concat(f.slice(i+1,f.length))),f.length>0?h.values[d]=f:delete h.values[d];return delete g[e]}}},f=function(a,b,c){h(m,a,b,c);return h(i,c,b,a)},j=function(a,b,c){g(m,a,b,c);return g(i,c,b,a)},l=function(b,c,d){var e,f,g,h,i,j,k,l,m,o;f=b.id,o=b.type,e=!1,g=function(a,b){var c,d,e;d=!0;if(a.length!==b.length)return!1;for(c=0,e=a.length;0<=e?c<e:c>e;0<=e?c++:c--)a[c]!==b[c]&&(d=!1);return d},l=function(a,b,c){var e,f,g,h;h=[];for(f=0,g=c.length;f<g;f++)e=c[f],h.push(d(a,b,e));return h},k=function(a,b,d){var e,f,g,h;h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(c(a,b,e));return h},a.isArray(f)&&(f=f[0]),a.isArray(o)&&(o=o[0]),i=n.getItem(f);for(j in b){h=b[j];if(typeof j!="string"||j==="id"||j==="type")continue;a.isArray(h)||(h=[h]),m=h.length,i[j]==null?(k(f,j,h),e=!0):g(h,i[j])||(e=!0,l(f,j,i[j]),k(f,j,h))}return e},n.events.onBeforeUpdating.fire(n),k=b.length,c=parseInt(k/100,10),c>200&&(c=200),c<1&&(c=1),d=function(a){var g,h,i;g=a+c,g>k&&(g=k);for(i=a;a<=g?i<g:i>g;a<=g?i++:i--)h=b[i],typeof h=="object"&&l(h,f,j)&&e.push(h.id);if(g<k)return setTimeout(function(){return d(g)},0);n.events.onAfterUpdating.fire(n);return n.events.onModelChange.fire(n,e)};return d(0)},n.loadItems=function(c,d){var e,f,g,j,k,o;g=[],j=function(a,b,c){h(m,a,b,c);return h(i,c,b,a)},k=function(c,d){var e,f,h,i,k,m;if(c.id==null)throw b.error("Item entry has no id: ",c);if(c.type==null)throw b.error("Item entry has no type: ",c);e=c.id,h=c.type,a.isArray(e)&&(e=e[0]),a.isArray(h)&&(h=h[0]),l.add(e),g.push(e),j(e,"type",h),j(e,"id",e),m=[];for(f in c){i=c[f];if(typeof f!="string")continue;m.push(function(){var b,c,d;if(f!=="id"&&f!=="type"){if(a.isArray(i)){d=[];for(b=0,c=i.length;b<c;b++)k=i[b],d.push(j(e,f,k));return d}if(i!=null)return j(e,f,i)}}())}return m},n.events.onBeforeLoading.fire(n),o=c.length,d!=null?(e=parseInt(o/100,10),e>200&&(e=200),e<1&&(e=1)):e=o,f=function(a){var b,h,i;b=a+e,b>o&&(b=o);for(i=a;a<=b?i<b:i>b;a<=b?i++:i--)h=c[i],typeof h=="object"&&k(h);return b<o?setTimeout(function(){return f(b)},0):setTimeout(function(){n.events.onAfterLoading.fire(n);return setTimeout(function(){n.events.onModelChange.fire(n,g);if(d!=null)return setTimeout(d,0)},0)},0)};return f(0)},n.prepare=function(a){var c,d;d=function(){var d,e,f;f=[];for(d=0,e=a.length;d<e;d++)c=a[d],f.push(b.Expression.initParser().parse(c));return f}();return{evaluate:function(a){var b,c,e,f,g;c=[],e=function(b){var d;d=b.evaluateOnItem(a,n);return c=c.concat(d.values.items())};for(f=0,g=d.length;f<g;f++)b=d[f],e(b);return c}}},n.getObjectsUnion=function(a,b,c,d){return e(m,a,b,c,d)},n.getSubjectsUnion=function(a,b,c,d){return e(i,a,b,c,d)};return n},d.initView=function(a){var c,e,g,h,i,j;h=b.initView("MITHGrid.Data.initView",a),g=d.initSet(),c=function(a){return!1!==h.events.onFilterItem.fire(h.dataStore,a)},e=function(a){var b,d,e,f;e=h.dataStore.items(),f=e.length;if(f===0)a();else{f>200?(b=parseInt(f/100,10),b>200&&(b=200)):b=f,b<1&&(b=1),d=function(i){var j,k,l;j=i+b,j>f&&(j=f);for(k=i;i<=j?k<j:k>j;i<=j?k++:k--)l=e[k],c(l)?g.add(l):g.remove(l);if(j<f)return setTimeout(function(){return d(j)},0);h.items=g.items,h.size=g.size,h.contains=g.contains;if(a!=null)return setTimeout(a,0)};return d(0)}},h.registerFilter=function(a){h.events.onFilterItem.addListener(function(b,c){return a.eventFilterItem(b,c)}),h.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return a.events.onFilterChange.addListener(h.eventFilterChange)},h.registerPresentation=function(a){h.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return e(function(){return a.eventModelChange(h,h.items())})},h.items=g.items,h.size=g.size,h.contains=g.contains,h.eventFilterChange=function(){var a;a=d.initSet(h.items());return e(function(){var b,c,e,f,g,i,j,k;b=d.initSet(),j=a.items();for(e=0,g=j.length;e<g;e++)c=j[e],h.contains(c)||b.add(c);k=h.items();for(f=0,i=k.length;f<i;f++)c=k[f],a.contains(c)||b.add(c);if(b.size()>0)return h.events.onModelChange.fire(h,b.items())})},h.eventModelChange=function(a,b){var e,f,i,j;e=d.initSet();for(i=0,j=b.length;i<j;i++)f=b[i],a.contains(f)?c(f)?(g.add(f),e.add(f)):g.contains(f)&&(e.add(f),g.remove(f)):(e.add(f),g.remove(f));if(e.size()>0)return h.events.onModelChange.fire(h,e.items())},(a!=null?(i=a.types)!=null?i.length:void 0:void 0)>0&&function(a){return h.registerFilter({eventFilterItem:function(b,c){var d,e,g,h;d=b.getItem(c);if(d.type==null)return!1;for(g=0,h=a.length;g<h;g++){e=a[g];if(f.call(d.type,e)>=0)return}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(a.types),(a!=null?(j=a.filters)!=null?j.length:void 0:void 0)>0&&function(a){var c,d,e;e=b.Expression.initParser(),d=function(){var b,d,f;f=[];for(b=0,d=a.length;b<d;b++)c=a[b],f.push(e.parse(c));return f}();return h.registerFilter({eventFilterItem:function(a,b){var c,e,f,g,h,i,j;for(g=0,i=d.length;g<i;g++){c=d[g],f=c.evaluateOnItem(b,a),f=f.values.items();for(h=0,j=f.length;h<j;h++){e=f[h];if(e!=="false")return}}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(a.filters),(a!=null?a.collection:void 0)!=null&&h.registerFilter({eventFilterItem:a.collection,eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}}),h.dataStore=a.dataStore,h.getItems=h.dataStore.getItems,h.getItem=h.dataStore.getItem,h.removeItems=h.dataStore.removeItems,h.fetchData=h.dataStore.fetchData,h.updateItems=h.dataStore.updateItems,h.loadItems=h.dataStore.loadItems,h.prepare=h.dataStore.prepare,h.addType=h.dataStore.addType,h.getType=h.dataStore.getType,h.addProperty=h.dataStore.addProperty,h.getProperty=h.dataStore.getProperty,h.getObjectsUnion=h.dataStore.getObjectsUnion,h.getSubjectsUnion=h.dataStore.getSubjectsUnion,h.dataStore.events.onModelChange.addListener(h.eventModelChange);return h},g=b.namespace("Expression"),l={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b}},"=":{valueType:"boolean",f:function(a,b){return a===b}},"<>":{valueType:"boolean",f:function(a,b){return a!==b}},"><":{valueType:"boolean",f:function(a,b){return a!==b}},"<":{valueType:"boolean",f:function(a,b){return a<b}},">":{valueType:"boolean",f:function(a,b){return a>b}},"<=":{valueType:"boolean",f:function(a,b){return a<=b}},">=":{valueType:"boolean",f:function(a,b){return a>=b}}},g.controls={"if":{f:function(a,b,c,d,e){var f,g;g=a[0].evaluate(b,c,d,e),f=!1,g.forEachValue(function(a){if(a){f=!0;return!0}});return f?a[1].evaluate(b,c,d,e):a[2].evaluate(b,c,d)}},foreach:{f:function(a,b,c,d,e){var f,h,i,j,k;f=a[0].evaluate(b,c,d,e),h=b.value,i=c.value,j=[],k="text",c.value=f.valueType,f.forEachValue(function(f){var g;b.value=f,g=a[1].evaluate(b,c,d,e),k=g.valueType;return g.forEachValue(function(a){return j.push(a)})}),b.value=h,c.value=i;return g.initCollection(j,k)}},"default":{f:function(a,b,c,d,e){var f,h,i,j;for(i=0,j=a.length;i<j;i++){f=a[i],h=f.evaluate(b,c,d,e);if(h.size()>0)return h}return g.initCollection([],"text")}}},g.initExpression=function(a){var b;b={},b.evaluate=function(b,c,d,e){var f;f=a.evaluate(b,c,d,e);return{values:f.getSet(),valueType:f.valueType,size:f.size}},b.evaluateOnItem=function(a,b){return this.evaluate({value:a},{value:"item"},"value",b)},b.evaluateSingle=function(b,c,d,e){var f,g;f=a.evaluate(b,c,d,e),g={value:null,valueType:f.valueType},f.forEachValue(function(a){g.value=a;return!0});return g},b.isPath=a.isPath,b.isPath?(b.getPath=function(){return a},b.testExists=function(b,c,d,e){return a.testExists(b,c,d,e)}):(b.getPath=function(){return null},b.testExists=function(a,c,d,e){return b.evaluate(a,c,d,e).values.size()>0}),b.evaluateBackward=function(b,c,d,e){return a.walkBackward([b],c,d,e)},b.walkForward=function(b,c,d){return a.walkForward(b,c,d)},b.walkBackward=function(b,c,d,e){return a.walkBackward(b,c,d,e)};return b},g.initCollection=function(a,c){var d;d={valueType:c},a instanceof Array?(d.forEachValue=function(b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++){c=a[d];if(b(c)===!0)break}return f},d.getSet=function(){return b.Data.initSet(a)},d.contains=function(b){return f.call(a,b)>=0},d.size=function(){return a.length}):(d.forEachValue=a.visit,d.size=a.size,d.getSet=function(){return a},d.contains=a.contains),d.isPath=!1;return d},g.initConstant=function(a,b){var c;c={},c.evaluate=function(c,d,e,f){return g.initCollection([a],b)},c.isPath=!1;return c},g.initOperator=function(a,b){var c,d,e;c={},e=a,d=b,c.evaluate=function(c,f,h,i){var j,k,m,n,o;m=[],b=[];for(n=0,o=d.length;n<o;n++)j=d[n],b.push(j.evaluate(c,f,h,i));a=l[e],k=a.f,a.argumentType==="number"?b[0].forEachValue(function(a){typeof a!="number"&&(a=parseFloat(a));return b[1].forEachValue(function(b){typeof b!="number"&&(b=parseFloat(b));return m.push(k(a,b))})}):b[0].forEachValue(function(a){return b[1].forEachValue(function(b){return m.push(k(a,b))})});return g.initCollection(m,a.valueType)},c.isPath=!1;return c},g.initFunctionCall=function(a,b){var c,d;c={},d=b,c.evaluate=function(c,e,f,h){var i,j,k,l;b=[];for(j=0,k=d.length;j<k;j++)i=d[j],b.push(i.evaluate(c,e,f,h));if(((l=g.functions[a])!=null?l.f:void 0)!=null)return g.functions[a].f(b);throw new Error("No such function named "+_name)},c.isPath=!1;return c},g.initControlCall=function(a,b){var c;c={},c.evaluate=function(c,d,e,f){return g.controls[a].f(b,c,d,e,f)},c.isPath=!1;return c},g.initPath=function(a,c){var d,e,f,h,i;d={},h=null,i=[],f=function(b,c){var d,e,f,h,j,k,l,m;f=function(a){var d;d=[],b.forEachValue(function(b){return c.getObjects(b,a.property).visit(function(a){return d.push(a)})});return d},e=function(a){var d;d=[],b.forEachValue(function(b){return c.getSubjects(b,a.property).visit(function(a){return d.push(a)})});return d};for(h=0,m=i.length;0<=m?h<m:h>m;0<=m?h++:h--)j=i[h],j.isMultiple?(d=[],j.forward?(d=f(j),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text"):(d=e(j),k="item"),b=g.initCollection(d,k)):j.forward?(l=c.getObjectsUnion(b.getSet(),j.property),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text",b=g.initCollection(l,k)):(l=c.getSubjectsUnion(b.getSet(),j.property),b=g.initCollection(l,"item"));return b},e=function(c,d,e){var f,h,j,k,l,m,n,o;j=function(a){var b;b=[],c.forEachValue(function(c){return e.getSubjects(c,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return b.push(a)})});return b},h=function(a){var b;b=[],c.forEachValue(function(c){return e.getObjects(c,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return b.push(a)})});return b},d instanceof Array&&(d=b.Data.initSet(d));for(k=o=i.length-1;o<=0?k<=0:k>=0;o<=0?k++:k--)l=i[k],l.isMultiple?(f=[],l.forward?(f=j(l),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text"):(f=h(l),m="item"),c=g.initCollection(f,m)):l.forward?(n=e.getSubjectsUnion(c.getSet(),l.property,null,k===0?d:null),c=g.initCollection(n,"item")):(n=e.getObjectsUnion(c.getSet(),l.property,null,k===0?d:null),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text",c=g.initCollection(n,m));return c},a!=null&&i.push({property:a,forward:c,isMultiple:!1}),d.isPath=!0,d.setRootName=function(a){return h=a},d.appendSegment=function(a,b){return i.push({property:a,forward:b[0]===".",isMultiple:b.length>1})},d.getSegment=function(a){var b;if(a<i.length){b=i[a];return{property:b.property,forward:b.forward,isMultiple:b.isMultiple}}return null},d.getLastSegment=function(){return d.getSegment(i.length-1)},d.getSegmentCount=function(){return i.length},d.rangeBackward=function(c,d,e,f){var g,h,j,k,l;j=b.Data.initSet(),k="item";if(i.length>0){h=i[i.length-1];if(h.forward)f.getSubjectsInRange(h.property,c,d,!1,j,i.length===1?e:null);else throw new Error("Last path of segment must be forward");for(g=l=i.length-2;l<=0?g<=0:g>=0;l<=0?g++:g--)h=i[g],h.forward?(j=f.getSubjectsUnion(j,h.property,null,g===0?e:null),k="item"):(j=f.getObjectsUnion(j,h.property,null,g===0?e:null),a=f.getPropertysegment.property,k=a!=null?a.getValueType():"text")}return{valueType:k,values:j,count:j.size()}},d.evaluate=function(a,b,c,d){var e,i,j,k;j=h!=null?h:c,k=b[j]!=null?b[j]:"text",e=null;if(a[j]!=null){i=a[j],i.isSet||i instanceof Array?e=g.initCollection(i,k):e=g.initCollection([i],k);return f(e,d)}throw new Error("No such variable called "+j)},d.testExists=function(a,b,c,e){return d.evaluate(a,b,c,e).size()>0},d.evaluateBackward=function(a,b,c,d){var f;f=g.initCollection([a],b);return e(f,c,d)},d.walkForward=function(a,b,c){return f(g.initCollection(a,b),c)},d.walkBackward=function(a,b,c,d){return e(g.initCollection(a,b),c,d)};return d},g.initParser=function(){var a,b;b={},a=function(a,b){var c,d,e,f,h,i,j,k,l,m,n,o,p,q,r;p=a.token(),c=g.initScanner,f=function(){a.next();return p=a.token()},j=function(){},m=function(){var a,b,d;b=j();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="*"||d==="/"))a=p.value,f(),b=g.initOperator(a,[b,j()]);return b},l=function(){var a,b,d;b=m();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="+"||d==="-"))a=p.value,f(),b=g.initOperator(a,[b,m()]);return b},h=function(){var a,b,d;a=l();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="="||d==="<>"||d==="<"||d===">"||d==="<="||d===">="))b=p.value,f(),a=g.initOperator(b,[a,l()]);return a},i=function(){var a;a=[h()];while(p!=null&&p.type===c.DELIMITER&&p.value===",")f(),a.push(h());return a},e=function(){return p!=null?p.start:a.index()},k=function(){var a,b;b=g.initPath();while(p!=null&&p.type===c.PATH_OPERATOR){a=p.value,f();if(p!=null&&p.type===c.IDENTIFIER)b.appendSegment(p.value,a),f();else throw new Error("Missing property ID at position "+e())}return b},j=function(){var a,b,d;d=null,a=[];if(p==null)throw new Error("Missing factor at end of expression");switch(p.type){case c.NUMBER:d=g.initConstant(p.value,"number"),f();break;case c.STRING:d=g.initConstant(p.value,"text"),f();break;case c.PATH_OPERATOR:d=k();break;case c.IDENTIFIER:b=p.value,f();if(g.controls[b]!=null){if(p==null||p.type!==c.DELIMITER||p.value!=="(")throw new Error("Missing ( to start "+b+" at position "+e());f(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=g.initControlCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")f();else throw new Error("Missing ) to end "+b+" at position "+e())}else if(p!=null&&p.type===c.DELIMITER&&p.value==="("){f(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=g.initFunctionCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")f();else throw new Error("Missing ) after function call "+b+" at position "+e())}else d=k(),d.setRootName(b);break;case c.DELIMITER:if(p.value!=="(")throw new Error("Unexpected text "+p.value+" at position "+e());f(),d=h();if(p!=null&&p.type===c.DELIMITER&&p.value===")")f();else throw new Error("Missing ) at position "+e());break;default:throw new Error("Unexpected text "+p.value+" at position "+e())}return d};if(b){o=i(),d=[];for(q=0,r=o.length;q<r;q++)n=o[q],d.push(g.initExpression(n));return d}return[g.initExpression(h())]},b.parse=function(b,c,d){var e;c!=null?c:c=0,d!=null?d:d={},e=g.initScanner(b,c);try{return a(e,!1)[0]}finally{d.index=e.token()!=null?e.token().start:e.index()}};return b},g.initScanner=function(a,b){var c,d,e,f,h,i;d={},h=a+" ",f=a.length,e=b,i=null,c=function(a){return"0123456789".indexOf(a)>=0},d.token=function(){return i},d.index=function(){return e},d.next=function(){var a,b,d,j;i=null;while(e<f&&" \t\r\n".indexOf(h.charAt(e))>=0)e+=1;if(e<f){b=h.charAt(e),d=h.charAt(e+1);if(".!".indexOf(b)<0){if("<>".indexOf(b)<0){if("+-*/=".indexOf(b)<0){if("()".indexOf(b)<0){if("\"'".indexOf(b)<0){if(c(b)){j=e;while(j<f&&c(h.charAt(j)))j+=1;if(j<f&&h.charAt(j)==="."){j+=1;while(j<f&&c(h.charAt(j)))j+=1}i={type:g.initScanner.NUMBER,value:parseFloat(h.substring(e,j)),start:e,end:j};return e=j}j=e;while(j<f){a=h.charAt(j);if("(),.!@ \t".indexOf(a)>=0)break;j+=1}i={type:g.initScanner.IDENTIFIER,value:h.substring(e,j),start:e,end:j};return e=j}j=e+1;while(j<f){if(h.charAt(j)===b&&h.charAt(j-1)!=="\\")break;j+=1}if(j<f){i={type:g.initScanner.STRING,value:h.substring(e+1,j).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:e,end:j+1};return e=j+1}throw new Error("Unterminated string starting at "+String(e))}i={type:g.initScanner.DELIMITER,value:b,start:e,end:e+1};return e+=1}i={type:g.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="="||"<>".indexOf(d)>=0&&b!==d){i={type:g.initScanner.OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:g.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="@"){i={type:g.initScanner.PATH_OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:g.initScanner.PATH_OPERATOR,value:b,start:e,end:e+1};return e+=1}},d.next();return d},g.initScanner.DELIMITER=0,g.initScanner.NUMBER=1,g.initScanner.STRING=2,g.initScanner.IDENTIFIER=3,g.initScanner.OPERATOR=4,g.initScanner.PATH_OPERATOR=5,g.functions={},g.FunctionUtilities={},g.FunctionUtilities.registerSimpleMappingFunction=function(a,c,d){return g.functions[a]={f:function(a){var e,f,h,i,j;h=b.Data.initSet(),f=function(a){return a.forEachValue(function(a){var b;b=c(a);if(b!=null)return h.add(b)})};for(i=0,j=a.length;i<j;i++)e=a[i],f(e);return g.initCollection(h,d)}}},b.namespace("Presentation"),b.Presentation.initPresentation=function(c,d,e){var f,g,h;h={},h=b.initView("MITHGrid.Presentation."+c,d,e),g={},f=h.options.lenses,e=h.options,a(d).empty(),h.getLens=function(a){if(a.type!=null&&a.type[0]!=null&&f[a.type[0]]!=null)return{render:f[a.type[0]]}},h.renderingFor=function(a){return g[a]},h.renderItems=function(a,b){var c,e,f;e=b.length,f=e,f>200&&(f=parseInt(Math.sqrt(f),10)+1),f<1&&(f=1),c=function(i){var j,k,l,m,o;if(i<e){j=i+f,j>e&&(j=e);for(l=i;i<=j?l<j:l>j;i<=j?l++:l--)m=b[l],k=a.contains(m),g[m]!=null?k?g[m].update(a.getItem(m)):(g[m].remove!=null&&g[m].remove(),delete g[m]):k&&(o=h.getLens(a.getItem(m)),o!=null&&(g[m]=o.render(d,h,a,m)));return setTimeout(function(){return c(j)},0)}return h.finishDisplayUpdate()},h.startDisplayUpdate();return c(0)},h.eventModelChange=h.renderItems,h.startDisplayUpdate=function(){},h.finishDisplayUpdate=function(){},h.selfRender=function(){return h.renderItems(h.dataView,h.dataView.items())},h.dataView=h.options.dataView,h.dataView.registerPresentation(h);return h},h=b.namespace("Facet"),h.initFacet=function(c,d,e){var f;f=b.initView(c,d,e),e=f.options,f.selfRender=function(){},f.eventFilterItem=function(a,b){return!1},f.eventModelChange=function(a,b){},f.constructFacetFrame=function(b,c){var d;d={},a(b).addClass("mithgrid-facet"),d.header=a("<div class='header' />"),c.onClearAllSelections!=null&&(d.controls=a("<div class='control' title='Clear Selection'>"),d.counter=a("<span class='counter'></span>"),d.controls.append(d.counter),d.header.append(d.controls)),d.title=a("<span class='title'></span>"),d.title.text(c.facetLabel||""),d.header.append(d.title),d.bodyFrame=a("<div class='body-frame'></div>"),d.body=a("<div class='body'></div>"),d.bodyFrame.append(d.body),a(b).append(d.header),a(b).append(d.bodyFrame),c.onClearAllSelections!=null&&d.controls.bind("click",c.onClearAllSelections),d.setSelectionCount=function(a){d.counter.innerHTML=a;return a>0?d.counter.show():d.counter.hide()};return d},f.events||(f.events={}),f.events.onFilterChange=fluid.event.getEventFirer(),e.dataView.registerFilter(f);return f},h.namespace("TextSearch"),h.TextSearch.initFacet=function(c,d){var e,f,g;g=h.initFacet("MITHGrid.Facet.TextSearch",c,d),d=g.options,d.expressions!=null&&(a.isArray(d.expressions)||(d.expressions=[d.expressions],f=function(){var a,c,f,g;f=d.expressions,g=[];for(a=0,c=f.length;a<c;a++)e=f[a],g.push(b.Expression.initParser().parse(e));return g}())),g.eventFilterItem=function(a,b){var c,e,h,i,j,k,l,m;if(g.text!=null&&d.expressions!=null)for(i=0,k=f.length;i<k;i++){c=f[i],e=c.evaluateOnItem(b,a),m=e.values.items();for(j=0,l=m.length;j<l;j++){h=m[j];if(h.toLowerCase().indexOf(g.text)>=0)return}}return!1},g.eventModelChange=function(a,b){},g.selfRender=function(){var b,e;b=g.constructFacetFrame(c,null,{facetLabel:d.facetLabel}),a(c).addClass("mithgrid-facet-textsearch"),e=a("<input type='text'>"),b.body.append(e);return e.keyup(function(){g.text=a.trim(e.val().toLowerCase());return g.events.onFilterChange.fire()})};return g},h.namespace("List"),h.List.initFacet=function(c,d){var e,g,i;i=h.initFacet("MITHGrid.Facet.List",c,d),d=i.options,i.selections=[],d.expressions!=null&&(a.isArray(d.expressions)||(d.expressions=[d.expressions],g=function(){var a,c,f,g;f=d.expressions,g=[];for(a=0,c=f.length;a<c;a++)e=f[a],g.push(b.Expression.initParser().parse(e));return g}())),i.eventFilterItem=function(a,b){var c,e,h,j,k,l,m,n,o;if(i.text!=null&&d.expressions!=null){o=[];for(j=0,l=g.length;j<l;j++){c=g[j],e=c.evaluateOnItem(b,a),n=e.values.items();for(k=0,m=n.length;k<m;k++){h=n[k];if(f.call(i.selections,h)>=0)return}}return o}},i.selfRender=function(){var a;return a=i.constructFacetFrame(c,null,{facetLabel:d.facetLabel,resizable:!0})};return i},c=b.namespace("Application"),c.initApp=function(c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;l=b.initView(c,d,e),g=[],l.presentation={},l.facet={},l.dataStore={},l.dataView={},e=l.options,l.ready=function(a){return g.push(a)};if((e!=null?e.dataStores:void 0)!=null){s=e.dataStores;for(k in s){f=s[k],l.dataStore[k]==null?(j=b.Data.initStore(),l.dataStore[k]=j,j.addType("Item"),j.addProperty("label",{valueType:"text"}),j.addProperty("type",{valueType:"text"}),j.addProperty("id",{valueType:"text"})):j=l.dataStore[k];if((f!=null?f.types:void 0)!=null){t=f.types;for(m in t)n=t[m],j.addType(m)}if((f!=null?f.properties:void 0)!=null){u=f.properties;for(h in u)i=u[h],j.addProperty(h,i)}}}if((e!=null?e.dataViews:void 0)!=null){v=e.dataViews;for(q in v)p=v[q],r={dataStore:l.dataStore[p.dataStore],label:q},l.dataView[q]==null&&(p.collection!=null&&(r.collection=p.collection),p.types!=null&&(r.types=p.types),p.filters!=null&&(r.filters=p.filters),o=b.Data.initView(r),l.dataView[q]=o)}(e!=null?e.viewSetup:void 0)!=null&&(a.isFunction(e.viewSetup)?l.ready(function(){return e.viewSetup(a(d))}):l.ready(function(){return a(d).append(e.viewSetup)})),(e!=null?e.facets:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j;i=e.facets,j=[];for(b in i)f=i[b],h=a.extend(!0,{},f),g=a(d).find(f.container),a.isArray(g)&&(g=g[0]),h.dataView=l.dataView[f.dataView],h.application=l,c=f.type.initFacet(g,h),l.facet[b]=c,j.push(c.selfRender());return j}),(e!=null?e.presentations:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j;i=e.presentations,j=[];for(b in i)c=i[b],g=a.extend(!0,{},c),f=a(d).find(g.container),a.isArray(f)&&(f=f[0]),g.dataView=l.dataView[c.dataView],g.application=l,h=c.type.initPresentation(f,g),l.presentation[b]=h,j.push(h.selfRender());return j}),(e!=null?e.plugins:void 0)!=null&&l.ready(function(){var b,c,f,g,h,i,j,k,m,n,o,p,q,r,s;r=e.plugins,s=[];for(p=0,q=r.length;p<q;p++)b=r[p],f=b.type.initPlugin(b),s.push(function(){var e,p,q,r;if(f!=null){if((b!=null?b.dataView:void 0)!=null){f.dataView=l.dataView[b.dataView],q=f.getTypes();for(n in q)o=q[n],f.dataView.addType(n);e=f.getProperties();for(j in e)k=e[j],f.dataView.addProperty(j,k)}p=f.getPresentations(),r=[];for(g in p)h=p[g],m=a.extend(!0,{},h.options),c=a(d).find(h.container),a.isArray(c)&&(c=c[0]),(h!=null?h.lenses:void 0)!=null&&(m.lenses=h.lenses),h.dataView!=null?m.dataView=l.dataView[h.dataView]:b.dataView!=null&&(m.dataView=l.dataView[b.dataView]),m.application=l,i=h.type.initPresentation(c,m),f.presentation[g]=i,r.push(i.selfRender());return r}}());return s}),l.run=function(){return a(document).ready(function(){var a,b,c;for(b=0,c=g.length;b<c;b++)a=g[b],a();g=[];return l.ready=function(a){return setTimeout(a,0)}})};return l},b.namespace("Plugin");return b.Plugin.initPlugin=function(a,b){var c,d;d={options:b,presentation:{}},c=[],d.getTypes=function(){return(b!=null?b.types:void 0)!=null?b.types:[]},d.getProperties=function(){return(b!=null?b.properties:void 0)!=null?b.properties:[]},d.getPresentations=function(){return(b!=null?b.presentations:void 0)!=null?b.presentations:[]},d.ready=c.push,d.eventReady=function(a){var b,e,f;for(e=0,f=c.length;e<f;e++)b=c[e],b(a);c=[];return d.ready=function(b){return b(a)}};return d}}(b,a),a.defaults("MITHGrid.Data.initStore",{events:{onModelChange:null,onBeforeLoading:null,onAfterLoading:null,onBeforeUpdating:null,onAfterUpdating:null}}),a.defaults("MITHGrid.Data.initView",{events:{onModelChange:null,onFilterItem:"preventable"}}),a.defaults("MITHGrid.Facet",{}),a.defaults("MITHGrid.Facet.TextSearch",{facetLabel:"Search",expressions:[".label"]})}).call(this);