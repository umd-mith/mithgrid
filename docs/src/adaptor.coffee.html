<!DOCTYPE html><html><head><title>adaptor.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../src/adaptor.coffee.html" class="source selected"><span class="base_path">src / </span><span class="file_name">adaptor.coffee</span></a><a href="../src/application.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">application.coffee</span></a><a href="../src/controller.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">controller.coffee</span></a><a href="../src/core.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">core.coffee</span></a><a href="../src/data.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">data.coffee</span></a><a href="../src/expression.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">expression.coffee</span></a><a href="../src/facet.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">facet.coffee</span></a><a href="../src/intro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">intro.coffee</span></a><a href="../src/outro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">outro.coffee</span></a><a href="../src/plugin.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">plugin.coffee</span></a><a href="../src/presentation.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">presentation.coffee</span></a><a href="../src/promise.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">promise.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>adaptor.coffee</h1><div class="filepath">src/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nv">Adaptor = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Adaptor&#39;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h1>#</h1>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><h1>#</h1>
</td><td class="code"><div class="highlight"><pre><span class="nv">Adaptor.initAdaptor = </span><span class="nf">(type, options) -&gt;</span>
  <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Adaptor&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
  <span class="nv">lenses = </span><span class="nx">options</span><span class="p">.</span><span class="nx">lenses</span>
  
  <span class="nv">that.export = </span><span class="nf">(dataView) -&gt;</span>
    <span class="nv">exporter = </span><span class="nx">that</span><span class="p">.</span><span class="nx">exporter</span><span class="p">()</span>
    <span class="nv">idList = </span><span class="p">{}</span>
    <span class="nv">me = </span><span class="p">{}</span>
    
    <span class="nv">exportProperty = </span><span class="nf">(name, values) -&gt;</span>
      <span class="nv">prop = </span><span class="nx">that</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">name</span>
      <span class="nv">propType = </span><span class="nx">prop</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span>
    
      <span class="nx">exporter</span><span class="p">.</span><span class="nx">beginProperty</span> <span class="nx">name</span><span class="p">,</span>
        <span class="nv">type: </span><span class="nx">propType</span>
    
      <span class="k">if</span> <span class="nx">propType</span> <span class="o">==</span> <span class="s">&quot;item&quot;</span>
        <span class="nx">exportItem</span> <span class="nx">id</span> <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">values</span>
      <span class="k">else</span>
        <span class="nx">exporter</span><span class="p">.</span><span class="nx">value</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>
  
      <span class="nv">exportItem = </span><span class="nf">(id) -&gt;</span>
      <span class="k">if</span> <span class="nx">idList</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
        <span class="nx">exporter</span><span class="p">.</span><span class="nx">itemReference</span> <span class="nx">id</span>
      <span class="k">else</span>
        <span class="nx">idList</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nv">item = </span><span class="nx">that</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span>
        <span class="nx">exporter</span><span class="p">.</span><span class="nx">beginItem</span> <span class="nx">id</span><span class="p">,</span>
          <span class="nv">type: </span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">values</span> <span class="k">of</span> <span class="nx">item</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="nx">prop</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span> <span class="p">]</span>
          <span class="nx">exportProperty</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">values</span>
        
        <span class="nx">exporter</span><span class="p">.</span><span class="nx">endItem</span> <span class="nx">id</span>
    
    <span class="nx">exporter</span><span class="p">.</span><span class="nx">beginExport</span><span class="p">()</span>
    <span class="nx">dataView</span><span class="p">.</span><span class="nx">visit</span> <span class="nx">exportItem</span>
    <span class="nx">exporter</span><span class="p">.</span><span class="nx">endExport</span><span class="p">()</span>
    <span class="nx">exporter</span><span class="p">.</span><span class="nx">export</span>

  <span class="nv">that.parse = </span><span class="nf">(data) -&gt;</span>
    <span class="nv">parser = </span><span class="nx">that</span><span class="p">.</span><span class="nx">parser</span><span class="p">()</span>
    <span class="nx">parser</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
    <span class="nx">parser</span><span class="p">.</span><span class="nx">finish</span><span class="p">()</span>
    <span class="nx">parser</span><span class="p">.</span><span class="nx">data</span>
    
  <span class="nv">that.exporter = </span><span class="nf">() -&gt;</span>
    <span class="nv">exporter = </span><span class="p">{}</span>
    <span class="nv">dataStack = </span><span class="p">[]</span>
    
    <span class="nv">exporter.push = </span><span class="nf">(ob) -&gt;</span> <span class="nx">dataStack</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ob</span>
    
    <span class="nv">exporter.pop = </span><span class="nf">() -&gt;</span> <span class="nx">dataStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      
    <span class="nv">exporter.peek = </span><span class="nf">(x = 0) -&gt;</span> 
      <span class="nv">l = </span><span class="nx">dataStack</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">return</span> <span class="p">{}</span> <span class="k">if</span> <span class="nx">l</span> <span class="o">&gt;=</span> <span class="nx">x</span>
      <span class="nx">dataStack</span><span class="p">[</span><span class="nx">dataStack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nx">x</span><span class="p">]</span>
    
    <span class="nv">exporter.beginExport = </span><span class="nf">() -&gt;</span>
      <span class="nv">dataStack = </span><span class="p">[]</span>
      
    <span class="nv">exporter.endExport = </span><span class="nf">() -&gt;</span>
      
    <span class="nv">exporter.beginItem = </span><span class="nf">(id, metadata) -&gt;</span>
      
    <span class="nv">exporter.endItem = </span><span class="nf">() -&gt;</span>
      
    <span class="nv">exporter.beginProperty = </span><span class="nf">(name, metadata) -&gt;</span>
    
    <span class="nv">exporter.endProperty = </span><span class="nf">() -&gt;</span>
    
    <span class="nv">exporter.itemReference = </span><span class="nf">(id) -&gt;</span>
    
    <span class="nv">exporter.value = </span><span class="nf">(value) -&gt;</span>
      
    <span class="nx">exporter</span>
    
  <span class="nv">that.parser = </span><span class="nf">() -&gt;</span>
    <span class="nv">parser = </span><span class="p">{}</span>
    <span class="nv">stack = </span><span class="p">[]</span>
    
    <span class="nv">parser.push = </span><span class="nf">(data) -&gt;</span>
    
    <span class="nv">parser.finish = </span><span class="nf">() -&gt;</span>
      
    <span class="nv">parser.start = </span><span class="nf">(type, data) -&gt;</span>
      
    <span class="nv">parser.end = </span><span class="nf">(type, data, startRet) -&gt;</span>
    
    <span class="nv">parser.stack = </span><span class="nf">(n) -&gt;</span>
      <span class="k">if</span> <span class="nx">n</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span>
          <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="p">{}</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
      
    <span class="nx">parser</span>
  
  

  <span class="nv">that.render = </span><span class="nf">(item) -&gt;</span>
    <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span>
      <span class="nv">lens = </span><span class="nx">lenses</span><span class="p">[</span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">lens</span><span class="o">?</span>
        <span class="nx">lens</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>

  <span class="nx">that</span>
  
<span class="nv">RDF = </span><span class="nx">Adaptor</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;RDF&#39;</span>

<span class="nv">RDF.initAdaptor = </span><span class="nf">(type, options) -&gt;</span>
  <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Adaptor.RDF&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">that = </span><span class="nx">Adaptor</span><span class="p">.</span><span class="nx">initAdaptor</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
  
  <span class="nv">superExporter = </span><span class="nx">that</span><span class="p">.</span><span class="nx">exporter</span>
  
  <span class="nv">that.exporter = </span><span class="nf">() -&gt;</span>
    <span class="nv">exporter = </span><span class="nx">superExporter</span><span class="p">()</span>
    <span class="nv">superMethods = </span><span class="p">{}</span>
    <span class="nv">rdfDatabank = </span><span class="p">{}</span>
    
    <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">exporter</span>
      <span class="nx">superMethods</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
    
    <span class="nv">exporter.add = </span><span class="nf">(s, p, o, type) -&gt;</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">p_uri = </span><span class="nx">options</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">uri</span>
      <span class="k">else</span>
        <span class="nv">p_uri = </span><span class="nx">p</span>
      
      <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&quot;text&quot;</span>
        <span class="nv">o = </span><span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\\&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\\\\&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\\&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&quot;date&quot;</span>
        <span class="nv">o = </span><span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\\&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\\\\&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\\&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>
        <span class="nv">o = </span><span class="nx">o</span> <span class="o">+</span> <span class="s">&quot;^^xsd:date&quot;</span>
      
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">s</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">o</span> <span class="o">+</span> <span class="s">&quot; .&quot;</span><span class="p">)</span>
      <span class="nx">exporter</span>

    <span class="nv">exporter.prefix = </span><span class="nf">(ns, href) -&gt;</span>
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span>
      <span class="nx">exporter</span>
    
    <span class="nv">exporter.beginExport = </span><span class="nf">() -&gt;</span>
      <span class="nx">superMethods</span><span class="p">.</span><span class="nx">beginExport</span><span class="p">()</span>
      <span class="nv">rdfDatabank = </span><span class="nx">$</span><span class="p">.</span><span class="nx">rdf</span><span class="p">.</span><span class="nx">databank</span><span class="p">().</span><span class="nx">base</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span>
          <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span>
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="s">&#39;xsd&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.w3.org/2001/XMLSchema#&#39;</span>
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="s">&#39;dc&#39;</span><span class="p">,</span> <span class="s">&#39;http://purl.org/dc/elements/1.1/&#39;</span>
      
    <span class="nv">exporter.endExport = </span><span class="nf">() -&gt;</span>
      <span class="nv">exporter.export = </span><span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">dump</span>
        <span class="nv">format: </span><span class="s">&#39;application/rdf+xml&#39;</span>
        <span class="nv">serialize: </span><span class="kc">true</span>
    
    <span class="nv">exporter.beginItem = </span><span class="nf">(id, metadata) -&gt;</span>
      <span class="nv">type_uri = </span><span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">uri</span>
      <span class="nx">exporter</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="nx">type_uri</span><span class="p">,</span> <span class="s">&#39;item&#39;</span><span class="p">)</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">peek</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">currentPropertyValues</span><span class="o">?</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">currentPropertyValues</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>

      <span class="nx">exporter</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nv">id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">type: </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">type</span> <span class="p">}</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">begin</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">metadata</span>
      
    <span class="nv">exporter.endItem = </span><span class="nf">() -&gt;</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">pop</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="nx">info</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">end</span> <span class="nx">info</span><span class="p">.</span><span class="nx">id</span>
      
    <span class="nv">exporter.beginProperty = </span><span class="nf">(name, metadata) -&gt;</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">peek</span><span class="p">()</span>
      <span class="nv">info.currentProperty = </span><span class="nx">name</span>
      <span class="nv">info.currentPropertyType = </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">type</span>
      <span class="nv">info.currentPropertyValues = </span><span class="p">[]</span>
    
    <span class="nv">exporter.endProperty = </span><span class="nf">() -&gt;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>now we can process the values for the property</p>
</td><td class="code"><div class="highlight"><pre>      
    
    <span class="nv">exporter.itemReference = </span><span class="nf">(id) -&gt;</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">peek</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">currentPropertyValues</span><span class="o">?</span>
        <span class="nx">info</span><span class="p">.</span><span class="nx">currentPropertyValues</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
    
    <span class="nv">exporter.value = </span><span class="nf">(value) -&gt;</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">peek</span><span class="p">()</span>
      <span class="nx">info</span><span class="p">.</span><span class="nx">currentPropertyValues</span><span class="p">.</span><span class="nx">push</span> <span class="nx">value</span>
      
    <span class="nx">exporter</span>
  
  <span class="nv">superParser = </span><span class="nx">that</span><span class="p">.</span><span class="nx">parser</span>
  
  <span class="nv">that.parser = </span><span class="nf">() -&gt;</span>
    <span class="nv">parser = </span><span class="nx">superParser</span><span class="p">()</span>
    <span class="nv">rdfDatabank = </span><span class="nx">$</span><span class="p">.</span><span class="nx">rdf</span><span class="p">.</span><span class="nx">databank</span><span class="p">().</span><span class="nx">base</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span>
        <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span>
    
    <span class="nv">parser.base = </span><span class="nf">(b) -&gt;</span>
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">base</span> <span class="nx">b</span>
      <span class="nx">parser</span>
      
    <span class="nv">parser.prefix = </span><span class="nf">(ns, href) -&gt;</span>
      <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">prefix</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">href</span>
      <span class="nx">parser</span>

    <span class="nv">parser.push = </span><span class="nf">(data) -&gt;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>assume XML</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">load</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{}</span>
      <span class="k">else</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>assume an array of turtle</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="nx">line</span> <span class="k">in</span> <span class="nx">data</span>
          <span class="nx">rdfDatabank</span><span class="p">.</span><span class="nx">add</span> <span class="nx">line</span>
      
    <span class="nv">parser.finish = </span><span class="nf">() -&gt;</span>
      <span class="nv">items = </span><span class="p">[]</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>now we walk the databank looking for things we can use to create events that lead to
info in the data store</p>

<p>?annotation a oac:annotation
?annotation oac:hasTarget ?target
?target a oac:ConstrainedTarget
?target oac:Constrains ?mediaURL
?target oac:ConstrainedBy ?svg
?svg a oac:SVGConstraint
?svg a cnt:ContentAsText
?svg cnt:chars ?svgBox
?svg cnt:characterEncoding "utf-8"
?annotation oac:hasBody ?body
?body a oac:Body
?body a cnt:ContentAsText
?body cnt:chars ?bodyText
?annotation dcterms:created ?createdAt
?annotation dcterms:creator ?createdBy
?annotation dc:title ?title</p>
</td><td class="code"><div class="highlight"><pre>      
      <span class="nv">annotation = </span><span class="s">&#39;&#39;</span>
      <span class="nv">mediaURL = </span><span class="s">&#39;&#39;</span>
      <span class="nv">svgBox = </span><span class="s">&#39;&#39;</span>
      <span class="nv">bodyText = </span><span class="s">&#39;&#39;</span>
      <span class="nv">createdAt = </span><span class="s">&#39;&#39;</span>
      <span class="nv">createdBy = </span><span class="s">&#39;&#39;</span>
      <span class="nv">title = </span><span class="s">&#39;&#39;</span>
      
      <span class="nv">svgBoxItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">SVGBoundingBoxToItem</span><span class="p">(</span><span class="nx">svgBox</span><span class="p">)</span>
      <span class="nv">svgBoxItem.id = </span><span class="nx">annotation</span> <span class="o">+</span> <span class="s">&#39;-svg-constraint&#39;</span>
      
      <span class="nv">bodyItem =</span>
        <span class="nv">id: </span><span class="nx">annotation</span> <span class="o">+</span> <span class="s">&#39;-body-text&#39;</span>
        <span class="nv">type: </span><span class="s">&#39;TextContent&#39;</span>
        <span class="nv">content: </span><span class="nx">bodyText</span>
    
      <span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">svgBoxItem</span>
      <span class="nx">items</span><span class="p">.</span><span class="nx">push</span> <span class="nx">bodyItem</span>
      
      <span class="nx">items</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">id: </span><span class="nx">annotation</span>
        <span class="nv">mediaURL: </span><span class="nx">mediaURL</span>
        <span class="nv">svgConstraint: </span><span class="nx">svgBoxItem</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">body: </span><span class="nx">bodyItem</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">createdAt: </span><span class="nx">createdAt</span>
        <span class="nv">createdBy: </span><span class="nx">createdBy</span>
        <span class="nv">title: </span><span class="nx">title</span>
      
      <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span> <span class="nx">items</span>
        
      
    
    <span class="nv">parser.start = </span><span class="nf">(type, data) -&gt;</span>
      
    <span class="nv">parser.end = </span><span class="nf">(type, data, startRet) -&gt;</span>
    
    <span class="nx">parser</span>
    
  
  <span class="nx">that</span>

<span class="nv">OAC = </span><span class="nx">RDF</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;OAC&#39;</span>

<span class="nv">OAC.initAdaptor = </span><span class="nf">(type, options) -&gt;</span>
  <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Adaptor.RDF.OAC&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">that = </span><span class="nx">RDF</span><span class="p">.</span><span class="nx">initAdaptor</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">options</span>
  <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
  
  <span class="nv">superExporter = </span><span class="nx">that</span><span class="p">.</span><span class="nx">exporter</span>
  
  <span class="nv">that.exporter = </span><span class="nf">() -&gt;</span>
    <span class="nv">exporter = </span><span class="nx">superExporter</span><span class="p">()</span>
    <span class="nv">superMethods = </span><span class="p">{}</span>
    <span class="nv">lastIds = </span><span class="p">{}</span>
    
    <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">exporter</span>
      <span class="nx">superMethods</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
    
    <span class="nv">exporter.beginExport = </span><span class="nf">() -&gt;</span>
      <span class="nx">superMethods</span><span class="p">.</span><span class="nx">beginExport</span><span class="p">()</span>
      <span class="nx">exporter</span><span class="p">.</span><span class="nx">prefix</span> <span class="s">&#39;oac&#39;</span><span class="p">,</span> <span class="s">&#39;http://www.openannotation.org/ns/&#39;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="s">&#39;Annotation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;oac:Annotation&#39;</span>
    
    <span class="nv">exporter.beginItem = </span><span class="nf">(id, metadata) -&gt;</span>
      <span class="nx">superExporter</span><span class="p">.</span><span class="nx">beginItem</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">metadata</span>
      <span class="nv">lastIds.annotation = </span><span class="nx">id</span>
      
    <span class="nv">exporter.addTarget = </span><span class="nf">(target, id) -&gt;</span>
      <span class="nx">id</span> <span class="o">?=</span> <span class="nx">lastIds</span><span class="p">.</span><span class="nx">annotation</span>
      <span class="nv">lastIds.target = </span><span class="nx">target</span>
      <span class="nx">exporter</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#39;oac:hasTarget&#39;</span><span class="p">,</span> <span class="nx">target</span>
      <span class="nx">exporter</span>
      
    <span class="nv">exporter.addBody = </span><span class="nf">(body, id) -&gt;</span>
      <span class="nx">id</span> <span class="o">?=</span> <span class="nx">lastIds</span><span class="p">.</span><span class="nx">annotation</span>
      <span class="nv">lastIds.body = </span><span class="nx">body</span>
      <span class="nx">exporter</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#39;oac:hasBody&#39;</span><span class="p">,</span> <span class="nx">body</span>
      <span class="nx">exporter</span>
          
    <span class="nv">exporter.endProperty = </span><span class="nf">() -&gt;</span>
      <span class="nv">info = </span><span class="nx">exporter</span><span class="p">.</span><span class="nx">peek</span><span class="p">();</span>
      
      <span class="nx">superExporter</span><span class="p">.</span><span class="nx">endProperty</span><span class="p">()</span>
    
  <span class="nv">that.parser = </span><span class="nf">() -&gt;</span>
    
  
  <span class="nx">that</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Tue Apr 03 2012 15:19:07 GMT-0400 (EDT)  </div><div id="projectname"><a href="../index.html">MITHGrid</a></div></div></body></html>