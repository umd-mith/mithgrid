---
layout: docco
title: mithgrid/code/src/expression.coffee.html
---
<div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../src/application.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">application.coffee</span></a><a href="../src/controller.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">controller.coffee</span></a><a href="../src/core.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">core.coffee</span></a><a href="../src/data.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">data.coffee</span></a><a href="../src/expression.coffee.html" class="source selected"><span class="base_path">src / </span><span class="file_name">expression.coffee</span></a><a href="../src/facet.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">facet.coffee</span></a><a href="../src/intro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">intro.coffee</span></a><a href="../src/outro.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">outro.coffee</span></a><a href="../src/plugin.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">plugin.coffee</span></a><a href="../src/presentation.coffee.html" class="source "><span class="base_path">src / </span><span class="file_name">presentation.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>expression.coffee</h1><div class="filepath">src/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h1>Expression Parser</h1>

<p>Everything here is private except for a few exported objects and functions.</p>

<h2>Expressions</h2>

<p>Expressions describe a path through the data graph held in a data store.</p>

<p>Expressions hop from node to node in one of two directions: forward or backward. Forward goes from an item ID through a property
to arrive at a new value. Backward goes from a value through a property to arrive at a new item ID.</p>

<p>For example, if we have a data store with items holding information about books, such as the following:</p>

<pre><code>[{
   id: "book1",
   author: "author1",
   title: "A Tale of Two Cities",
   pages: 254
 }, {
   id: "author1",
   name: "Charles Dickens"
 }]
</code></pre>

<p>Then .name would return "Charles Dickens" if we started with the item ID "author1". But .author.name would return the same
value if we started with the item ID "book1".</p>

<p>If we start with "Charles Dickens" (the value), we can find the number of pages in the books with the following expression:
!name!author.pages (or &lt;-name&lt;-author->pages using the longer notation).</p>

<p>. and -> use a forward index and must have an item ID on the left side</p>

<p>! and &lt;- use a reverse index and will result in an item ID on the right side</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Expression.Basic&quot;</span><span class="p">,</span> <span class="nf">(exports) -&gt;</span>
  <span class="nv">Expression = </span><span class="p">{}</span>
  <span class="nv">_operators =</span>
    <span class="s">&quot;+&quot;</span><span class="o">:</span>
      <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
    <span class="s">&quot;-&quot;</span><span class="o">:</span>
      <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span>
    <span class="s">&quot;*&quot;</span><span class="o">:</span>
      <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span>
    <span class="s">&quot;/&quot;</span><span class="o">:</span>
      <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">/</span> <span class="nx">b</span>
    <span class="s">&quot;=&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span>
    <span class="s">&quot;&lt;&gt;&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span>
    <span class="s">&quot;&gt;&lt;&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span>
    <span class="s">&quot;&lt;&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span>
    <span class="s">&quot;&gt;&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span>
    <span class="s">&quot;&lt;=&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&lt;=</span> <span class="nx">b</span>
    <span class="s">&quot;&gt;=&quot;</span><span class="o">:</span>
      <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
      <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&gt;=</span> <span class="nx">b</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h2>MITHGrid.Expression.Basic.controls</h2>

<p>Control functions may be defined for use in expressions. See the existing control functions for examples of
how to write them.</p>

<p>All control functions take the following parameters:</p>

<ul>
<li>args</li>
<li>roots</li>
<li>rootValueTypes</li>
<li>defaultRootName</li>
<li>database</li>
</ul>

<p>All control functions should return a collection of items (using MITHGrid.Expression.initCollection collections)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">Expression.controls = exports.controls =</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><h3>if</h3>
</td><td class="code"><div class="highlight"><pre>    <span class="s">&quot;if&quot;</span><span class="o">:</span>
      <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
        <span class="nv">conditionCollection = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
        <span class="nv">condition = </span><span class="kc">false</span>
        <span class="nx">conditionCollection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
          <span class="k">if</span> <span class="nx">v</span>
            <span class="nv">condition = </span><span class="kc">true</span>
            <span class="k">return</span> <span class="kc">true</span>
          <span class="k">else</span>
            <span class="k">return</span> <span class="kc">undefined</span>
      
        <span class="k">if</span> <span class="nx">condition</span>
          <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
        <span class="k">else</span>
          <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h3>foreach</h3>
</td><td class="code"><div class="highlight"><pre>    <span class="s">&quot;foreach&quot;</span><span class="o">:</span>
      <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
        <span class="nv">collection = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
        <span class="nv">oldValue = </span><span class="nx">roots</span><span class="p">.</span><span class="nx">value</span>
        <span class="nv">oldValueType = </span><span class="nx">rootValueTypes</span><span class="p">.</span><span class="nx">value</span>
        <span class="nv">results = </span><span class="p">[]</span>
        <span class="nv">valueType = </span><span class="s">&quot;text&quot;</span>

        <span class="nv">rootValueTypes.value = </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>

        <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(element) -&gt;</span>
          <span class="nv">roots.value = </span><span class="nx">element</span>
          <span class="nv">collection2 = </span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
          <span class="nv">valueType = </span><span class="nx">collection2</span><span class="p">.</span><span class="nx">valueType</span>

          <span class="nx">collection2</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(result) -&gt;</span>
            <span class="nx">results</span><span class="p">.</span><span class="nx">push</span> <span class="nx">result</span>

        <span class="nv">roots.value = </span><span class="nx">oldValue</span>
        <span class="nv">rootValueTypes.value = </span><span class="nx">oldValueType</span>

        <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">valueType</span>
    <span class="s">&quot;default&quot;</span><span class="o">:</span>
      <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
        <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
          <span class="nv">collection = </span><span class="nx">arg</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
          <span class="k">if</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="nx">collection</span>
        <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[],</span> <span class="s">&quot;text&quot;</span>

  <span class="nv">Expression.initExpression = </span><span class="nf">(rootNode) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nv">collection = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">values: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">()</span>
        <span class="nv">valueType: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>
        <span class="nv">size: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">size</span>
      <span class="p">}</span>
    
    <span class="nv">that.evaluateOnItem = </span><span class="nf">(itemID, database) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">({</span>
        <span class="s">&quot;value&quot;</span><span class="o">:</span> <span class="nx">itemID</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="s">&quot;value&quot;</span><span class="o">:</span> <span class="s">&quot;item&quot;</span>
      <span class="p">},</span>
      <span class="s">&quot;value&quot;</span><span class="p">,</span>
      <span class="nx">database</span>
      <span class="p">)</span>

    <span class="nv">that.evaluateSingle = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nv">collection = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
      <span class="nv">result =</span>
        <span class="nv">value: </span><span class="kc">null</span>
        <span class="nv">valueType: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>

      <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
        <span class="nv">result.value = </span><span class="nx">v</span>
        <span class="kc">true</span>

      <span class="nx">result</span><span class="p">;</span>

    <span class="nv">that.isPath = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">isPath</span>

    <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">isPath</span>
      <span class="nv">that.getPath = </span><span class="nf">() -&gt;</span> <span class="nx">rootNode</span> 
      <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
        <span class="nx">rootNode</span><span class="p">.</span><span class="nx">testExists</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
    <span class="k">else</span>
      <span class="nv">that.getPath = </span><span class="nf">() -&gt;</span> <span class="kc">null</span>
      <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">).</span><span class="nx">values</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
  
    <span class="nv">that.evaluateBackward = </span><span class="nf">(value, valueType, filter, database) -&gt;</span>
      <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkBackward</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nv">that.walkForward = </span><span class="nf">(values, valueType, database) -&gt;</span>
      <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkForward</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nv">that.walkBackward = </span><span class="nf">(values, valueType, filter, database) -&gt;</span>
      <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkBackward</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initCollection = exports.initCollection = </span><span class="nf">(values, valueType) -&gt;</span>
    <span class="nv">that =</span>
      <span class="nv">valueType: </span><span class="nx">valueType</span>

    <span class="k">if</span> <span class="nx">values</span> <span class="k">instanceof</span> <span class="nb">Array</span>

      <span class="nv">that.forEachValue = </span><span class="nf">(f) -&gt;</span>
        <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>
          <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span>
            <span class="k">break</span><span class="p">;</span>

      <span class="nv">that.getSet = </span><span class="nf">() -&gt;</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">initInstance</span> <span class="nx">values</span>

      <span class="nv">that.contains = </span><span class="nf">(v) -&gt;</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>

      <span class="nv">that.size = </span><span class="nf">() -&gt;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">else</span>
      <span class="nv">that.forEachValue = </span><span class="nx">values</span><span class="p">.</span><span class="nx">visit</span>
      <span class="nv">that.size = </span><span class="nx">values</span><span class="p">.</span><span class="nx">size</span>
      <span class="nv">that.getSet = </span><span class="nf">() -&gt;</span> <span class="nx">values</span>
      <span class="nv">that.contains = </span><span class="nx">values</span><span class="p">.</span><span class="nx">contains</span>

    <span class="nv">that.isPath = </span><span class="kc">false</span><span class="p">;</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initConstant = </span><span class="nf">(value, valueType) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span>

    <span class="nv">that.isPath = </span><span class="kc">false</span><span class="p">;</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initOperator = </span><span class="nf">(operator, args) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>
    <span class="nv">_operator = </span><span class="nx">operator</span>
    <span class="nv">_args = </span><span class="nx">args</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nv">values = </span><span class="p">[]</span>
      <span class="nv">args = </span><span class="p">[]</span>

      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">)</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">_args</span>

      <span class="nv">operator = </span><span class="nx">_operators</span><span class="p">[</span><span class="nx">_operator</span><span class="p">]</span>
      <span class="nv">f = </span><span class="nx">operator</span><span class="p">.</span><span class="nx">f</span>
      <span class="k">if</span>  <span class="nx">operator</span><span class="p">.</span><span class="nx">argumentType</span> <span class="o">==</span> <span class="s">&quot;number&quot;</span>
        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v1) -&gt;</span>
          <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;number&quot;</span>
            <span class="nv">v1 = </span><span class="nb">parseFloat</span> <span class="nx">v1</span>

          <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v2) -&gt;</span>
            <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;number&quot;</span>
              <span class="nv">v2 = </span><span class="nb">parseFloat</span> <span class="nx">v2</span>

            <span class="nx">values</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v1) -&gt;</span>
          <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v2) -&gt;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">)</span>

      <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">operator</span><span class="p">.</span><span class="nx">valueType</span>

    <span class="nv">that.isPath = </span><span class="kc">false</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initFunctionCall = </span><span class="nf">(name, args) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>
    <span class="nv">_args = </span><span class="nx">args</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nv">args = </span><span class="p">[]</span>

      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">_args</span>

      <span class="k">if</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">f</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">f</span> <span class="nx">args</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No such function named </span><span class="si">#{</span><span class="nx">_name</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nv">that.isPath = </span><span class="kc">false</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initControlCall = </span><span class="nf">(name, args) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nx">Expression</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">f</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nv">that.isPath = </span><span class="kc">false</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initPath = </span><span class="nf">(property, forward) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>
    <span class="nv">_rootName = </span><span class="kc">null</span>
    <span class="nv">_segments = </span><span class="p">[]</span>
  
    <span class="nv">walkForward = </span><span class="nf">(collection, database) -&gt;</span>
      <span class="nv">forwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
        <span class="nv">a = </span><span class="p">[]</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
          <span class="nx">database</span><span class="p">.</span><span class="nx">getObjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span>
        <span class="nx">a</span>

      <span class="nv">backwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
        <span class="nv">a = </span><span class="p">[]</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
          <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span>
        <span class="nx">a</span>

      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">...</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="p">]</span>
        <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
          <span class="nv">a = </span><span class="p">[]</span>
          <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
            <span class="nv">a = </span><span class="nx">forwardArraySegmentFn</span> <span class="nx">segment</span>
            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
          <span class="k">else</span>
            <span class="nv">a = </span><span class="nx">backwardArraySegmentFn</span> <span class="nx">segment</span>
            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">valueType</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
            <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
            <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span>
          <span class="k">else</span>
            <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="s">&quot;item&quot;</span>

      <span class="nx">collection</span>

    <span class="nv">walkBackward = </span><span class="nf">(collection, filter, database) -&gt;</span>
      <span class="nv">forwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
        <span class="nv">a = </span><span class="p">[]</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
          <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="o">!</span><span class="nx">filter</span><span class="o">?</span> <span class="o">or</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">v2</span>
        <span class="nx">a</span>

      <span class="nv">backwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
        <span class="nv">a = </span><span class="p">[]</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
          <span class="nx">database</span><span class="p">.</span><span class="nx">getObjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="o">!</span><span class="nx">filter</span><span class="o">?</span> <span class="o">or</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">v2</span>
        <span class="nx">a</span>

      <span class="k">if</span> <span class="nx">filter</span> <span class="k">instanceof</span> <span class="nb">Array</span>
        <span class="nv">filter = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">initInstance</span> <span class="nx">filter</span>

      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
          <span class="nv">a = </span><span class="p">[]</span>
          <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
            <span class="nv">a = </span><span class="nx">forwardArraySegmentFn</span> <span class="nx">segment</span>
            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
          <span class="k">else</span>
            <span class="nv">a = </span><span class="nx">backwardArraySegmentFn</span> <span class="nx">segment</span>
            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">valueType</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
          <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="s">&quot;item&quot;</span>
        <span class="k">else</span>
          <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
          <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span>

      <span class="nx">collection</span>

    <span class="k">if</span> <span class="nx">property</span><span class="o">?</span>
      <span class="nx">_segments</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">property: </span><span class="nx">property</span>
        <span class="nv">forward: </span><span class="nx">forward</span>
        <span class="nv">isMultiple: </span><span class="kc">false</span>

    <span class="nv">that.isPath = </span><span class="kc">true</span>

    <span class="nv">that.setRootName = </span><span class="nf">(rootName) -&gt;</span> <span class="nv">_rootName = </span><span class="nx">rootName</span>

    <span class="nv">that.appendSegment = </span><span class="nf">(property, hopOperator) -&gt;</span>
      <span class="nx">_segments</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">property: </span><span class="nx">property</span>
        <span class="nv">forward: </span><span class="nx">hopOperator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span>
        <span class="nv">isMultiple: </span><span class="nx">hopOperator</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="nv">that.getSegment = </span><span class="nf">(index) -&gt;</span>
      <span class="k">if</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="nv">property: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
          <span class="nv">forward: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
          <span class="nv">isMultiple: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
        <span class="p">}</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kc">null</span>

    <span class="nv">that.getLastSegment = </span><span class="nf">() -&gt;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getSegment</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nv">that.getSegmentCount = </span><span class="nf">() -&gt;</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">that.rangeBackward = </span><span class="nf">(from, to, filter, database) -&gt;</span>
      <span class="nv">set = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">()</span>
      <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>

      <span class="k">if</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
          <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsInRange</span><span class="p">(</span><span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="k">if</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Last path of segment must be forward&quot;</span>

        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">..</span> <span class="mi">0</span> <span class="p">]</span>
          <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
            <span class="nv">set = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
          <span class="k">else</span>
            <span class="nv">set = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getPropertysegment</span><span class="p">.</span><span class="nx">property</span>
            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>

      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">valueType: </span><span class="nx">valueType</span>
        <span class="nv">values: </span><span class="nx">set</span>
        <span class="nv">count: </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span>
      <span class="p">}</span>

    <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nv">rootName = </span><span class="k">if</span> <span class="nx">_rootName</span><span class="o">?</span> <span class="k">then</span> <span class="nx">_rootName</span> <span class="k">else</span> <span class="nx">defaultRootName</span>
      <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">rootValueTypes</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">rootValueTypes</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
      <span class="nv">collection = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">roots</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">root = </span><span class="nx">roots</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="o">or</span> <span class="nx">root</span> <span class="k">instanceof</span> <span class="nb">Array</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">valueType</span>
        <span class="k">else</span>
          <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">root</span><span class="p">],</span> <span class="nx">valueType</span>

        <span class="k">return</span> <span class="nx">walkForward</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">database</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No such variable called &quot;</span> <span class="o">+</span> <span class="nx">rootName</span>

    <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nv">that.evaluateBackward = </span><span class="nf">(value, valueType, filter, database) -&gt;</span>
      <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span>
      <span class="nx">walkBackward</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nv">that.walkForward = </span><span class="nf">(values, valueType, database) -&gt;</span>
      <span class="nx">walkForward</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">),</span> <span class="nx">database</span>

    <span class="nv">that.walkBackward = </span><span class="nf">(values, valueType, filter, database) -&gt;</span>
      <span class="nx">walkBackward</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">),</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initParser = exports.initInstance = </span><span class="o">-&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>
  
    <span class="nv">internalParse = </span><span class="nf">(scanner, several) -&gt;</span>
      <span class="nv">token = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span>
      <span class="nv">Scanner = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span>
    
      <span class="nv">next = </span><span class="nf">() -&gt;</span>
        <span class="nx">scanner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
        <span class="nv">token = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span>

      <span class="nv">parseExpressionList = </span><span class="nf">() -&gt;</span>
        <span class="nv">expressions = </span><span class="p">[</span><span class="nx">parseExpression</span><span class="p">()]</span>
        <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;,&quot;</span>
          <span class="nx">next</span><span class="p">()</span>
          <span class="nx">expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parseExpression</span><span class="p">()</span>
        <span class="nx">expressions</span>

      <span class="nv">makePosition = </span><span class="nf">() -&gt;</span> <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="k">then</span> <span class="nx">token</span><span class="p">.</span><span class="nx">start</span> <span class="k">else</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">index</span><span class="p">()</span>

      <span class="nv">parsePath = </span><span class="nf">() -&gt;</span>
        <span class="nv">path = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initPath</span><span class="p">()</span>

        <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
          <span class="nv">hopOperator = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
          <span class="nx">next</span><span class="p">()</span>
        
          <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
            <span class="nx">path</span><span class="p">.</span><span class="nx">appendSegment</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">hopOperator</span>
            <span class="nx">next</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing property ID at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
        <span class="nx">path</span>

      <span class="nv">parseExpression = </span><span class="nf">() -&gt;</span>
        <span class="nv">result = </span><span class="kc">null</span>
        <span class="nv">args = </span><span class="p">[]</span>

        <span class="k">if</span> <span class="o">!</span><span class="nx">token</span><span class="o">?</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing factor at end of expression&quot;</span>

        <span class="k">switch</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span>
          <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">NUMBER</span>
            <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initConstant</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;number&quot;</span>
            <span class="nx">next</span><span class="p">()</span>
          <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">STRING</span>
            <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initConstant</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;text&quot;</span><span class="p">);</span>
            <span class="nx">next</span><span class="p">();</span>
          <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span> <span class="k">then</span> <span class="nv">result = </span><span class="nx">parsePath</span><span class="p">()</span>
          <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
            <span class="nv">identifier = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
            <span class="nx">next</span><span class="p">()</span>

            <span class="k">if</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">identifier</span><span class="p">]</span><span class="o">?</span>
              <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
                <span class="nx">next</span><span class="p">()</span>

                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span> 
                  <span class="nv">args = </span><span class="p">[]</span>
                <span class="k">else</span>
                  <span class="nv">args = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
                <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initControlCall</span> <span class="nx">identifier</span><span class="p">,</span> <span class="nx">args</span>

                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                  <span class="nx">next</span><span class="p">()</span>
                <span class="k">else</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) to end &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
              <span class="k">else</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ( to start &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
                <span class="nx">next</span><span class="p">()</span>
              
                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                  <span class="nv">args = </span><span class="p">[]</span>
                <span class="k">else</span>
                  <span class="nv">args = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
                <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initFunctionCall</span> <span class="nx">identifier</span><span class="p">,</span> <span class="nx">args</span>

                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                  <span class="nx">next</span><span class="p">()</span>
                <span class="k">else</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) after function call &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
              <span class="k">else</span>
                <span class="nv">result = </span><span class="nx">parsePath</span><span class="p">()</span>
                <span class="nx">result</span><span class="p">.</span><span class="nx">setRootName</span> <span class="nx">identifier</span>
          <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span>
            <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
              <span class="nx">next</span><span class="p">()</span>

              <span class="nv">result = </span><span class="nx">parseExpression</span><span class="p">()</span>
              <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                <span class="nx">next</span><span class="p">()</span>
              <span class="k">else</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unexpected text &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unexpected text &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
        <span class="nx">result</span>

      <span class="k">if</span> <span class="nx">several</span>
        <span class="nv">roots = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
        <span class="nv">expressions = </span><span class="p">[]</span>
        <span class="nx">expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initExpression</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">roots</span>
        <span class="k">return</span> <span class="nx">expressions</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initExpression</span><span class="p">(</span><span class="nx">parseExpression</span><span class="p">())]</span>

    <span class="nv">that.parse = </span><span class="nf">(s, startIndex, results) -&gt;</span>
      <span class="nx">startIndex</span> <span class="o">?=</span> <span class="mi">0</span>
      <span class="nx">results</span> <span class="o">?=</span> <span class="p">{}</span>

      <span class="nv">scanner = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">startIndex</span>
      <span class="k">try</span>
        <span class="k">return</span> <span class="nx">internalParse</span><span class="p">(</span><span class="nx">scanner</span><span class="p">,</span> <span class="kc">false</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">finally</span>
        <span class="nv">results.index = </span><span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span><span class="o">?</span> <span class="k">then</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">().</span><span class="nx">start</span> <span class="k">else</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">index</span><span class="p">()</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initScanner = </span><span class="nf">(text, startIndex) -&gt;</span>
    <span class="nv">that = </span><span class="p">{}</span>
    <span class="nv">_text = </span><span class="nx">text</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
    <span class="nv">_maxIndex = </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">_index = </span><span class="nx">startIndex</span>
    <span class="nv">_token = </span><span class="kc">null</span>

    <span class="nv">isDigit = </span><span class="nf">(c) -&gt;</span> <span class="s">&quot;0123456789&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="nv">that.token = </span><span class="nf">() -&gt;</span> <span class="nx">_token</span>

    <span class="nv">that.index = </span><span class="nf">() -&gt;</span> <span class="nx">_index</span>

    <span class="nv">that.next = </span><span class="nf">() -&gt;</span>
      <span class="nv">_token = </span><span class="kc">null</span>

      <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">_index</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="s">&quot; \t\r\n&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

      <span class="k">if</span> <span class="nx">_index</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
        <span class="nv">c1 = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span>
        <span class="nv">c2 = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nv">c3 = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="s">&quot;.!&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="k">if</span> <span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;@&quot;</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="nx">c1</span> <span class="o">+</span> <span class="nx">c2</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
          <span class="k">else</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="nx">c1</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">c1</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span> <span class="o">and</span> <span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span>
          <span class="k">if</span> <span class="nx">c3</span> <span class="o">==</span> <span class="s">&quot;@&quot;</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="s">&quot;!@&quot;</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">3</span>
          <span class="k">else</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="s">&quot;!&quot;</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">c1</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span> <span class="o">and</span> <span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span>
          <span class="k">if</span> <span class="nx">c3</span> <span class="o">==</span> <span class="s">&quot;@&quot;</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="s">&quot;.@&quot;</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">3</span>
          <span class="k">else</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
              <span class="nv">value: </span><span class="s">&quot;.&quot;</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;&lt;&gt;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;=&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="s">&quot;&lt;&gt;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">c1</span> <span class="o">!=</span> <span class="nx">c2</span><span class="p">)</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
              <span class="nv">value: </span><span class="nx">c1</span> <span class="o">+</span> <span class="nx">c2</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
          <span class="k">else</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
              <span class="nv">value: </span><span class="nx">c1</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;+-*/=&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="nv">_token =</span>
            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
            <span class="nv">value: </span><span class="nx">c1</span>
            <span class="nv">start: </span><span class="nx">_index</span>
            <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;()&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="nv">_token =</span>
            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">DELIMITER</span>
            <span class="nv">value: </span><span class="nx">c1</span>
            <span class="nv">start: </span><span class="nx">_index</span>
            <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;\&quot;&#39;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>quoted strings</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">i = </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
            <span class="k">break</span> <span class="k">if</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="nx">c1</span> <span class="o">and</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;\\&quot;</span>
            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
            <span class="nv">_token =</span>
              <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">STRING</span>
              <span class="nv">value: </span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&#39;/g</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&quot;/g</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
              <span class="nv">start: </span><span class="nx">_index</span>
              <span class="nv">end: </span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nv">_index = </span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unterminated string starting at &quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">(</span><span class="nx">_index</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">isDigit</span> <span class="nx">c1</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>number</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">i = </span><span class="nx">_index</span>
          <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">isDigit</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span><span class="p">)</span>

          <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span>
            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">isDigit</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span><span class="p">)</span>

          <span class="nv">_token =</span>
            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">NUMBER</span>
            <span class="nv">value: </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span>
            <span class="nv">start: </span><span class="nx">_index</span>
            <span class="nv">end: </span><span class="nx">i</span>
          <span class="nv">_index = </span><span class="nx">i</span><span class="p">;</span>
        <span class="k">else</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>identifier</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nv">i = </span><span class="nx">_index</span>

          <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
            <span class="nv">c = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span>
            <span class="k">break</span> <span class="nx">unless</span> <span class="s">&quot;(),.!@ \t&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="nv">_token =</span>
            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
            <span class="nv">value: </span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
            <span class="nv">start: </span><span class="nx">_index</span>
            <span class="nv">end: </span><span class="nx">i</span>
          <span class="nv">_index = </span><span class="nx">i</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>

    <span class="nx">that</span>

  <span class="nv">Expression.initScanner.DELIMITER = </span><span class="mi">0</span>
  <span class="nv">Expression.initScanner.NUMBER = </span><span class="mi">1</span>
  <span class="nv">Expression.initScanner.STRING = </span><span class="mi">2</span>
  <span class="nv">Expression.initScanner.IDENTIFIER = </span><span class="mi">3</span>
  <span class="nv">Expression.initScanner.OPERATOR = </span><span class="mi">4</span>
  <span class="nv">Expression.initScanner.PATH_OPERATOR = </span><span class="mi">5</span>

  <span class="nv">Expression.functions = </span><span class="p">{</span> <span class="p">}</span>
  <span class="nv">Expression.FunctionUtilities = </span><span class="p">{</span> <span class="p">}</span>

  <span class="nv">exports.registerSimpleMappingFunction = </span><span class="nf">(name, f, valueType) -&gt;</span>
    <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span>
      <span class="nv">f: </span><span class="nf">(args) -&gt;</span>
        <span class="nv">set = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">()</span>
        <span class="nv">evalArg = </span><span class="nf">(arg) -&gt;</span>
          <span class="nx">arg</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
            <span class="nv">v2 = </span><span class="nx">f</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">v2</span><span class="o">?</span>

        <span class="nx">evalArg</span> <span class="nx">arg</span> <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>

        <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">valueType</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Tue Jan 08 2013 13:10:49 GMT-0500 (EST)  </div><div id="projectname"><a href="../index.html">MITHgrid</a></div></div>